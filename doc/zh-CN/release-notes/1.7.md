<!-- Language: zh-CN -->
<p><a href="./README.md">ğŸ“‹ æ‰€æœ‰ç‰ˆæœ¬</a> <span style="float:right"><a href="../../en-US/release-notes/1.7.md">English</a> | <b>ç®€ä½“ä¸­æ–‡</b></span></p>

# Chats 1.7.0 å‘å¸ƒè¯´æ˜ï¼ˆé‡å¤§æ›´æ–°ï¼‰

> å‘å¸ƒæ—¥æœŸï¼š2025-09-20ï¼ˆç›¸å¯¹ 1.6.9.30 ä»¥æ¥ 100+ æ¬¡æäº¤ï¼‰

1.7.0 æ˜¯ä¸€æ¬¡éå¸¸å¤§çš„ç‰ˆæœ¬å‡çº§ï¼Œæ ¸å¿ƒå›´ç»• MCPï¼ˆModel Context Protocolï¼‰å…¨é¢è½åœ°ä¸å·¥å…·è°ƒç”¨ä½“éªŒæ‰“é€ ï¼Œå¹¶ä¼´éšæ•°æ®åº“ä¸æ•°æ®æ¨¡å‹çš„å¤§è§„æ¨¡é‡æ„ã€æ¨¡å‹/å¯†é’¥/é¢„è®¾çš„æ‹–æ‹½æ’åºã€æ–°çš„ Markdown Mermaid æ¸²æŸ“ã€å›¾ç‰‡å°ºå¯¸æ§åˆ¶åŠå¤§é‡å‰åç«¯ä½“éªŒæ”¹è¿›ä¸é—®é¢˜ä¿®å¤ã€‚

## äº®ç‚¹æ¦‚è§ˆ

- å…¨é¢æ”¯æŒ MCPï¼šæœåŠ¡ç«¯/å‰ç«¯è”åŠ¨ã€ç”¨æˆ·çº§æˆæƒã€å·¥å…·æŠ“å–ã€ä¼šè¯è°ƒç”¨ä¸æƒé™æ ¡éªŒ
- å·¥å…·è°ƒç”¨ï¼ˆTool Callï¼‰å¼ºåŒ–ï¼šSSE äº‹ä»¶æ›´ä¸°å¯Œã€æ¶ˆæ¯å†…å®¹æ–°å¢å·¥å…·è¯·æ±‚/å“åº”ç±»å‹ã€å‰ç«¯æµå¼å±•ç¤º
- æ•°æ®æ¨¡å‹ä¸æ•°æ®åº“é‡æ„ï¼ˆç ´åæ€§å˜æ›´ï¼‰ï¼šMessageâ†’ChatTurn/Step åˆ†å±‚ã€å†å²æ•°æ®è¿ç§»è„šæœ¬ã€é»˜è®¤å€¼çº¦æŸæ¸…ç†
- æ¨¡å‹ä¸å¯†é’¥ç®¡ç†é‡æ„ï¼šProvider/Key/Model æ”¯æŒæ‰‹é£ç´åˆ†ç»„ä¸æ‹–æ‹½æ’åºï¼Œåå° API ä¸è¡¨ç»“æ„é…å¥—
- èŠå¤©ä½“éªŒå‡çº§ï¼šå•æ¡/æ•´æ®µé‡æ–°ç”Ÿæˆã€ç³»ç»Ÿæç¤ºç¼–è¾‘/æ¸²æŸ“æ¨¡å¼ã€è‡ªåŠ¨éšè—è¾“å…¥ã€æ›´ä¸°å¯Œçš„çŠ¶æ€æç¤º
- Markdown Mermaid æ–°å¢ï¼šæ›´ä¼˜æš—/äº®ä¸»é¢˜é€‚é…ã€å…¨å±æŸ¥çœ‹ã€ç¼“å­˜ä¸å»æŠ–åŠ¨ã€æµå¼å‹å¥½
- å›¾ç‰‡ç”Ÿæˆå°ºå¯¸ï¼šæ–°å¢å¸¸ç”¨å°ºå¯¸å¹¶å¯åœ¨ä¼šè¯ä¸­æŒ‡å®š
- OpenAI å…¼å®¹é¢æ›´å¼ºï¼šå·¥å…·è°ƒç”¨é€‚é…ä¿®å¤ï¼ˆå« gpt-5/Qwen ç­‰ï¼‰ã€Keycloak ç™»å½•å…¼å®¹æå‡ã€Google AI è”è°ƒé€šè¿‡

---

## æ–°åŠŸèƒ½ä¸æ”¹è¿›è¯¦æƒ…

### 1) MCPï¼ˆModel Context Protocolï¼‰æ”¯æŒ

åç«¯æ–°å¢å®ä½“ä¸å…³ç³»ï¼š
- è¡¨ï¼š`McpServer`ã€`McpTool`ã€`UserMcp`ã€`ChatConfigMcp`
- `UserMcp` ç²¾å‡†æ§åˆ¶ç”¨æˆ·å¯¹ MCP Server çš„è®¿é—®ï¼Œåˆ›å»ºè€…è‡ªåŠ¨è¢«åˆ†é…
- Server æ ‡ç­¾å…¨å±€å”¯ä¸€ï¼Œç¦æ­¢åŒ…å«å†’å· `:`ï¼›Headers å¿…é¡»ä¸ºç©ºæˆ–åˆæ³• JSON å¯¹è±¡

åç«¯ APIï¼ˆèŠ‚é€‰ï¼‰ï¼š
- åˆ—è¡¨/ç®¡ç†/è¯¦æƒ…ï¼š`GET /api/mcp`ã€`GET /api/mcp/management`ã€`GET /api/mcp/{id}`
- åˆ›å»º/æ›´æ–°/åˆ é™¤ï¼š`POST /api/mcp`ã€`PUT /api/mcp/{id}`ã€`DELETE /api/mcp/{id}`
- æŠ“å–å·¥å…·ï¼š`POST /api/mcp/fetch-tools`ï¼ˆSSE è¿æ¥è¿œç«¯ MCP Server æšä¸¾å·¥å…·ï¼‰
- ç”¨æˆ·åˆ†é…ï¼š`POST /api/mcp/{id}/assign-to-users`ã€æŸ¥è¯¢æœªåˆ†é…ä¸å·²åˆ†é…ç”¨æˆ·ç­‰

èŠå¤©è”åŠ¨ï¼š
- æ¯ä¸ª Chat Span å¯ç»‘å®šå¤šä¸ª MCPï¼ˆ`ChatConfigMcp`ï¼‰
- æœåŠ¡ç«¯ä¼šåœ¨ä¼šè¯å‰æ ¡éªŒå½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡å¯¹åº” MCP Server çš„è®¿é—®æƒé™ï¼ˆåŸºäº `UserMcp`ï¼‰
- å·¥å…·è°ƒç”¨æµå¼è¾“å‡ºï¼Œå‚æ•°ä¸ç»“æœå†™å…¥æ¶ˆæ¯å†…å®¹ï¼Œå‰ç«¯å¯è§†åŒ–å±•ç¤º

å‰ç«¯ç®¡ç†ï¼š
- è®¾ç½®é¡µæ–°å¢ã€ŒMCPã€æ ‡ç­¾é¡µï¼Œå¯æ–°å¢/ç¼–è¾‘ MCP Serverã€æŠ“å–å·¥å…·ã€åˆ†é…ç”¨æˆ·ã€æŒ‰æƒé™æ˜¾ç¤ºå¯ç¼–è¾‘çŠ¶æ€

### 2) å·¥å…·è°ƒç”¨ä¸æµå¼åè®®

- SSE äº‹ä»¶ç§ç±»æ‰©å±•ï¼ˆ`SseResponseKind`ï¼‰ï¼š`CallingTool`ã€`ToolProgress`ã€`ToolCompleted`ã€`StartResponse`ã€`StartReasoning`ã€`ImageGenerated` ç­‰
- æ¶ˆæ¯å†…å®¹æ–°å¢ç±»å‹ï¼š`toolCall`ã€`toolResponse`ï¼ˆå‰ç«¯å°†å·¥å…·å‚æ•°æµå¼æ‹¼è£…å¹¶æ˜¾ç¤ºè°ƒç”¨ç»“æœï¼‰
- æœåŠ¡ç«¯ SSE è¾“å‡ºç»“æ„é‡‡ç”¨æ›´ä¸°å¯Œçš„ Json å¤šæ€æ ¼å¼ï¼Œå‰ç«¯ç±»å‹å·²åŒæ­¥æ›´æ–°

### 3) æ•°æ®åº“ä¸æ•°æ®æ¨¡å‹é‡æ„ï¼ˆç ´åæ€§å˜æ›´ï¼‰

ä¸ºæå‡å¯ç»´æŠ¤æ€§ä¸å¯è§‚æµ‹æ€§ï¼Œæœ¬æ¬¡å¯¹æ¶ˆæ¯å­˜å‚¨å±‚è¿›è¡Œé‡æ„ã€‚

- è¡¨ä¸æ¨¡å‹è°ƒæ•´ï¼š
  - `Message` â†’ `ChatTurn`
  - `MessageContent*` â†’ `Step*`ï¼ˆæ–°å¢ `Step` è¡¨ï¼Œ`StepContent` å…³è” `Step`ï¼‰
  - `Chat.LeafMessageId` â†’ `LeafTurnId`
- ç”¨é‡å…³è”å˜æ›´ï¼š
  - `UserModelUsage` ä¸å†å¼•ç”¨ `UserModel`ï¼Œæ”¹ä¸º `UserId` + `ModelId`
  - `UsageTransaction` ä¸å†å¼•ç”¨ `UserModel`ï¼Œæ”¹ä¸ºç›´æ¥ `ModelId`
  - åˆ é™¤ `UserModel.IsDeleted`
- å½’æ¡£ä¸æ€§èƒ½ï¼š
  - æ–°å¢ `ChatConfigArchived` å­˜æ¡£è¡¨ï¼Œè¿ç§»åŸ `HashCode` å¹¶è‡ª `ChatConfig` ç§»é™¤
- æ’åºèƒ½åŠ›é“ºå«ï¼š
  - `ModelKey` å¢åŠ  `Order`ï¼Œ`Model.Order` æ”¹ä¸ºéç©º
  - `ChatPreset` å¢åŠ  `Order`
- é»˜è®¤å€¼çº¦æŸæ¸…ç†ï¼šåˆ é™¤å¤šå¤„é»˜è®¤å€¼çº¦æŸä»¥é¿å…â€œéšå¼å†™å…¥â€ï¼Œç»Ÿä¸€ç”±åº”ç”¨å±‚æ˜¾å¼æ§åˆ¶
- è¿ç§»è„šæœ¬ï¼ˆSQL Serverï¼‰ï¼š`src/scripts/db-migration/1.7/20250516-mcp.sql`

> æ³¨æ„ï¼šæ­¤éƒ¨åˆ†ä¸ºç ´åæ€§å˜æ›´ï¼Œå‡çº§å‰åŠ¡å¿…å¤‡ä»½æ•°æ®åº“å¹¶ä¸¥æ ¼æŒ‰å‡çº§æŒ‡å—æ‰§è¡Œã€‚

### 4) æ¨¡å‹ä¸å¯†é’¥ç®¡ç†

- å…¨æ–°æ¨¡å‹ç®¡ç†é¡µé¢ï¼šProvider/Key çš„æ‰‹é£ç´å¼å±•å¼€
- åŸºäº dnd-kit çš„æ‹–æ‹½æ’åºï¼šæ”¯æŒ Providerã€Modelã€ModelKey çš„é¡ºåºè°ƒæ•´
- åç«¯æä¾›å¯¹åº”çš„é‡æ’åº API ä¸å­—æ®µï¼Œæ”¯æŒç²¾ç»†åŒ–æ’åºæŒä¹…åŒ–
- æ”¯æŒç”¨æˆ·çº§æ¨¡å‹ç®¡ç†ã€ç”¨é‡ç»Ÿè®¡è·³è½¬ã€Provider å›¾æ ‡å±•ç¤º

### 5) èŠå¤©ä½“éªŒä¸æ˜“ç”¨æ€§

- é‡æ–°ç”Ÿæˆï¼š
  - å•æ¡é‡æ–°ç”Ÿæˆï¼š`POST /api/chats/regenerate-assistant-message`
  - ä»æŸæ¡ç”¨æˆ·æ¶ˆæ¯å¼€å§‹é‡æ–°ç”Ÿæˆè¯¥æ®µåçš„æ‰€æœ‰åŠ©æ‰‹æ¶ˆæ¯ï¼š`POST /api/chats/regenerate-all-assistant-message`
- ç³»ç»Ÿæç¤ºï¼šæ–°å¢ã€Œç¼–è¾‘/æ¸²æŸ“ã€åŒæ¨¡å¼
- å›¾ç‰‡å°ºå¯¸ï¼šæ”¯æŒ 1024Ã—1024ã€1536Ã—1024ã€1024Ã—1536ï¼ˆ`KnownImageSize` ä¸ `ChatConfig.ImageSizeId`ï¼‰
- Mermaid Markdownï¼š
  - æ–°å¢ `MermaidBlock` ä¸å…¨å±æŸ¥çœ‹ç»„ä»¶ï¼Œæš—/äº®ä¸»é¢˜é€‚é…
  - æµå¼æ¸²æŸ“å»æŠ–ã€SVG ç¼“å­˜ä¸å¼‚å¸¸å›é€€ï¼Œå‡å°‘é—ªçƒä¸å¤±è´¥
- å…¶ä»–ä¼˜åŒ–ï¼š
  - è¾“å…¥æ¡†åœ¨æ¨¡å‹ç”Ÿæˆæ—¶è‡ªåŠ¨éšè—ï¼Œæå‡æ²‰æµ¸ä½“éªŒ
  - ä¾§è¾¹æ å¤šå›¾æ ‡ã€æŒ‰é’®æç¤ºã€ç¦ç”¨æ€æç¤ºã€ç§»åŠ¨ç«¯é¡µé¢ä¸å¤šå¤„ UI å¾®è°ƒ

### 6) OpenAI å…¼å®¹ä¸ç¬¬ä¸‰æ–¹

- OpenAI Compatible é€šé“ç»§ç»­å®Œå–„
- ä¿®å¤ gpt-5/Qwen ç­‰æ¨¡å‹åœ¨å·¥å…·è°ƒç”¨åœºæ™¯çš„å…¼å®¹é—®é¢˜
- Keycloak ç™»å½•å…¼å®¹æ€§ä¼˜åŒ–
- Google AI é€šé“è”è°ƒé€šè¿‡

### 7) ç®¡ç†ç­–ç•¥ä¸æƒé™

- MCP Server æ ‡ç­¾å”¯ä¸€ä¸”ç¦ç”¨ `:`ï¼ŒHeaders å¿…é¡»ä¸ºç©ºæˆ– JSON å¯¹è±¡
- é»˜è®¤ä¸è‡ªåŠ¨åŠ è½½ MCP æœåŠ¡ï¼Œè®¿é—®å®Œå…¨ä»¥ `UserMcp` æ§åˆ¶

### 8) é—®é¢˜ä¿®å¤ä¸æ‚é¡¹

- å¤šå¤„å‰ç«¯æ„å»º/è¿è¡Œé”™è¯¯ä¿®å¤ï¼Œä¾èµ–å‡çº§ä¸æ¸…ç† `console.log`
- å…±äº«é¡µæ˜¾ç¤ºã€åˆå§‹é…ç½®åŠ è½½/ä¿å­˜ã€æ¨¡å‹å¼•ç”¨åŠ è½½ã€ç©ºè½®æ¬¡ä¸è¾¹ç•Œæƒ…å†µä¿®å¤
- æç¤ºè¯/æ ‡é¢˜çš„è‹¥å¹²ä¿®å¤ä¸æ–‡æ¡ˆå¾®è°ƒ
- è„šæœ¬ï¼šæ–°å¢/åˆå¹¶æ¢å¤è„šæœ¬ï¼ˆå¦‚ `restore-dev.local`ï¼‰ï¼Œ`dev.win.sql` æ›´æ–°

---

## å‡çº§æŒ‡å—ï¼ˆåŠ¡å¿…é˜…è¯»ï¼‰

1. å¤‡ä»½æ•°æ®åº“ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰
2. åœ¨ SQL Server ä¸Šæ‰§è¡Œè¿ç§»è„šæœ¬ï¼š`src/scripts/db-migration/1.7/20250516-mcp.sql`
3. åç«¯é‡æ–°æ„å»ºä¸éƒ¨ç½²ï¼›å‰ç«¯ä¾èµ–å˜åŒ–è¾ƒå¤šï¼Œå»ºè®®åˆ é™¤ `src/FE/node_modules` åé‡æ–°å®‰è£…ä¾èµ–å¹¶æ„å»º
4. ä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•ï¼Œå‰å¾€ã€Œè®¾ç½® â†’ MCPã€æ–°å¢æˆ–å¯¼å…¥ MCP Serverï¼Œå¹¶æŒ‰éœ€åˆ†é…ç»™ç”¨æˆ·
5. å¦‚éœ€ä½¿ç”¨æ’åºèƒ½åŠ›ï¼Œå‰å¾€æ¨¡å‹ç®¡ç†ç•Œé¢è¿›è¡Œ Provider/Model/Key/é¢„è®¾ çš„æ‹–æ‹½æ’åº

> å¦‚æ‚¨æœ‰ç›´æ¥ä¾èµ–æ•°æ®åº“ç»“æ„æˆ–é»˜è®¤å€¼çš„å¤–éƒ¨è„šæœ¬/æŠ¥è¡¨ï¼Œè¯·æ®æ­¤ç‰ˆæœ¬çš„ç»“æ„è°ƒæ•´ç›¸åº”é€»è¾‘ã€‚

---

## API å˜åŒ–ï¼ˆèŠ‚é€‰ï¼‰

- æ–°å¢èŠå¤©å†ç”Ÿæˆï¼š
  - `POST /api/chats/regenerate-assistant-message`
  - `POST /api/chats/regenerate-all-assistant-message`
- æ–°å¢ MCP ç®¡ç†/åˆ†é…ï¼š
  - `GET /api/mcp`ã€`GET /api/mcp/management`ã€`GET /api/mcp/{id}`
  - `POST /api/mcp`ã€`PUT /api/mcp/{id}`ã€`DELETE /api/mcp/{id}`
  - `POST /api/mcp/fetch-tools`
  - `POST /api/mcp/{id}/assign-to-users`ã€`GET /api/mcp/{id}/get-unassigned-users`ã€`GET /api/mcp/{id}/assigned-user-details`ã€`GET /api/mcp/{id}/assigned-user-names`
- SSE äº‹ä»¶ç»“æ„ï¼šé‡‡ç”¨æ›´ä¸°å¯Œçš„ Json å¤šæ€ï¼ˆå‰ç«¯ `SseResponseKind` ä¸è”åˆç±»å‹å·²åŒ¹é…ï¼‰

---

## ç ´åæ€§å˜æ›´æ¸…å•

- å¤§èŒƒå›´æ•°æ®åº“ç»“æ„è°ƒæ•´ä¸é‡å‘½åï¼Œå¿…é¡»æ‰§è¡Œè¿ç§» SQL
- `UserModelUsage/UsageTransaction` ä¸å†å¼•ç”¨ `UserModel`ï¼›åˆ é™¤ `UserModel.IsDeleted`
- `Chat.LeafMessageId` â†’ `LeafTurnId`
- åˆ é™¤å¤šå¤„é»˜è®¤å€¼çº¦æŸï¼›å¦‚å¤–éƒ¨ä¾èµ–é»˜è®¤å€¼ï¼Œè¯·åŒæ­¥è°ƒæ•´

---

## å·²çŸ¥æç¤º

- è¿œç«¯ MCP å·¥å…·æšä¸¾ä¾èµ–å¯¹æ–¹æœåŠ¡ï¼Œå·¥å…·è¾ƒå¤šæ—¶é¦–æ¬¡æŠ“å–å¯èƒ½è€—æ—¶
- ä¸ªåˆ«ç¬¬ä¸‰æ–¹æ¨¡å‹çš„å·¥å…·è°ƒç”¨åœ¨è¾¹ç•Œæƒ…å†µä¸‹ä»å¯èƒ½å­˜åœ¨ä¸å…¼å®¹ï¼Œè¯·ä»¥æœåŠ¡å•†è§„èŒƒä¸ºå‡†è°ƒæ•´

---

## è‡´è°¢

- æ„Ÿè°¢ç¤¾åŒºè´¡çŒ®è€…çš„æ”¯æŒï¼ç‰¹åˆ«æ„Ÿè°¢ PR #96ï¼ˆby @xiehs211ï¼‰å¸¦æ¥çš„ç™»å½•é¡µé¢è¿è¡Œæ—¶é”™è¯¯ä¿®å¤ã€‚

---

å¦‚å¯¹æœ¬ç‰ˆæœ¬æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ä»“åº“æäº¤ Issue æˆ– PRã€‚ç¥ä½¿ç”¨æ„‰å¿«ï¼
