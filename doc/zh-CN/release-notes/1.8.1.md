<!-- Language: zh-CN -->
<p align="right"><a href="../../en-US/release-notes/1.8.1.md">English</a> | <b>简体中文</b></p>

# Chats 1.8.1 发布说明

> 发布日期：2025-11-11（相对 1.8.0.247 以来 29 次提交）

1.8.1 是一次重要的功能增强版本，核心亮点包括**全新的用户模型权限管理系统**、**推理内容生命周期追踪与自动折叠**、**文件预览组件重构**以及**聊天列表缓存优化**。此版本还新增了 TokenPony 提供商支持，将 Azure OpenAI 品牌升级为 Azure AI Foundry，并修复了 OpenAI 2.6.0 升级带来的推理内容解析问题。

## 🎯 核心功能

### 1) 用户模型权限管理系统

**全新的管理界面**：
- 新增 `/admin/user-models` 管理页面（按用户维度管理）
- 新增模型页面的"模型用户"管理功能（按模型维度管理）
- 树形结构展示用户 → 模型密钥 → 模型权限关系
- 支持批量授权/撤销模型访问权限

**核心组件**（共 3 个新组件）：
- `ByUserTab.tsx`（1,180 行）- 按用户查看和管理模型权限
  - 用户列表（支持搜索和筛选）
  - 骨架屏加载状态
  - URL 状态持久化（支持分享和刷新保持状态）
- `UserModelTree.tsx`（912 行）- 树形展示用户的模型权限
  - 三层结构：提供商 → 模型密钥 → 模型
  - 复选框全选/半选状态管理
  - 批量权限更新
- `ModelUserList.tsx`（506 行）- 从模型视角管理用户权限
  - 展示有权访问该模型的用户列表
  - 支持添加/移除用户权限
  - 抽屉式界面（最大高度 384px，可滚动）

**交互优化**：
- URL 作为状态的唯一数据源（支持分享和浏览器导航）
- 搜索条件和过滤器自动同步到 URL 参数
- 页面刷新后保持筛选和搜索状态
- 模型列表页新增"用户权限"操作按钮

**后端支持**：
- 新增用户列表查询接口（优化加载性能）
- 新增模型用户列表接口（按模型查询授权用户）
- 批量权限更新接口（减少网络请求）

### 2) 推理内容生命周期追踪与自动折叠

**推理状态追踪**：
- 新增 `finished` 标志到 `ReasoningContent` 类型
  - `finished: false` - 推理进行中（自动展开显示）
  - `finished: true` - 推理已完成（自动折叠）
  - `undefined` - 历史数据（视为已完成）
- 实时标记推理段的生命周期状态
- 当接收到任何非推理 SSE 事件时，自动标记为已完成

**智能折叠行为**：
- `ThinkingMessage` 组件自动根据 `finished` 状态展开/折叠
  - 推理进行中：自动展开，显示实时思考过程
  - 推理完成：自动折叠，节省屏幕空间
- `ToolCallBlock` 组件自动折叠优化
  - 工具响应到达时自动折叠工具调用详情
  - 支持手动切换，用户操作优先级最高
- 所有自动折叠行为尊重用户的手动切换操作

**防止过早 API 调用**：
- 新增 `chatStatus` 守卫条件
- 避免在流式传输期间调用推理时长 API
- 避免使用临时消息 ID（`RESPONSE_MESSAGE_TEMP_ID`）发起请求
- 修复"输入字符串格式不正确"错误

**后端支持**：
- 通过工具执行链传递 `cancellationToken`
- 支持正确的取消处理机制

### 3) 文件预览组件重构

**新增 `FilePreview` 组件**（270 行）：
- 统一的文件预览和交互体验
- 支持多种文件类型：
  - 图片（自动显示）
  - 视频（HTML5 播放器）
  - 音频（HTML5 播放器）
  - 文档（图标 + 文件名 + 下载按钮）
- 智能文件类型识别（基于 `contentType` 和 `fileName`）

**新增文件类型图标**（7 个）：
- PDF（`IconFilePdf`）
- Word（`IconFileWord`）
- Excel（`IconFileExcel`）
- PowerPoint（`IconFilePpt`）
- ZIP 压缩包（`IconFileZip`）
- 文本文件（`IconFileText`）
- 通用文件（`IconFile`）

**统一的交互特性**：
- 悬停效果（半透明遮罩 + 缩放）
- 删除按钮（可选，带确认）
- 下载按钮（非图片文件）
- 图片点击预览（集成 `ImagePreview` 组件）
- 一致的样式和行为

**应用范围**：
- `ChatInput` - 消息输入框的附件预览
- `ResponseMessage` - 响应消息中的文件显示
- `UserMessage` - 用户消息中的文件显示
- 替代了三个地方的重复代码

**后端重构**：
- 文件处理逻辑从 `ChatController` 移至 `ChatService`
- 支持内容类型检查移至 `ChatCompletionService` 层
- 修复 `gemini-2.0-flash-exp` 文件支持问题
- 通过 ImageSharp 库改进文件类型支持（支持 JPEG、PNG、GIF、WebP、BMP 等）

**清理工作**：
- 删除 `GeneratedImageSize` 类及其数据库映射
- 删除 `KnownImageSize` 类及其数据库映射
- 这些类在 1.8.0 中已不再使用

### 4) 聊天列表缓存优化

**新增 `chatCache.ts` 工具模块**（122 行）：
- 聊天列表数据缓存到 `localStorage`
- 缓存键绑定到用户名（`chat_groups_cache_{username}`）
- 自动过期机制（24 小时）
- 搜索关键词敏感（不同搜索词使用不同缓存）

**加载流程优化**：
- 先从缓存加载聊天列表（即时显示）
- 并行发起所有初始 API 请求（聊天列表、用户信息、模型列表等）
- API 返回后更新缓存和界面
- 移除阻塞式的全屏加载屏

**用户体验提升**：
- 首次进入应用时立即显示聊天列表（无需等待 API）
- 感知性能大幅提升（从空白到内容的时间缩短）
- 网络较慢时体验改善明显

**安全性保障**：
- 登出时自动清除缓存（防止跨用户数据泄露）
- 缓存验证用户名匹配（防止用户切换后看到旧数据）
- 缓存不匹配时自动清除并重新加载

**其他优化**：
- 新建聊天按钮添加加载状态（显示 Spinner + 禁用按钮）
- 防止重复点击创建多个聊天
- `handleNewChat` 返回 Promise 以支持正确的异步处理

### 5) 提供商管理增强

**新增 TokenPony 提供商**（ID=19）：
- 提供商名称：TokenPony（小马算力）
- 默认 URL：`https://api.tokenpony.cn/v1`
- 新增 `tokenpony.svg` 图标
- 完整的中英文翻译支持

**Azure 品牌升级**：
- `DBModelProvider.AzureOpenAI` → `DBModelProvider.AzureAIFoundry`（枚举值保持为 1）
- `AzureChatCompletionService` → `AzureAIFoundryChatService`（类重命名）
- 图标更新：`azure-openai.svg` → `azure-ai-foundry.svg`
- Azure 服务自动处理 URL（自动追加 `/openai/v1/` 如果不存在）

**URL 转换逻辑**：
- 新增 `TransformAzureAIFoundryHost` 方法（自动追加路径）
- 新增 `CreateTransformedModelKey` 方法（统一转换逻辑）
- `AzureResponseApiService` 和 `AzureImageGenerationService` 复用转换方法
- 减少重复代码，提升可维护性

**提供商选择器 UI 优化**：
- 从下拉菜单改为图标网格布局
- 响应式列数（4-8 列，根据屏幕宽度自动调整）
- 可滚动容器（最大高度限制）
- 响应式内边距（移动端显示更友好）
- 修复深色主题下 Ollama/OpenRouter/GitHub 图标背景问题（移除黑色背景）

**ChatService 架构简化**：
- 移除所有 `ChatService` 构造函数中的 `suggestedApiUrl` 参数
- URL 回退逻辑简化：`ModelKey.Host` → `ModelProviderInfo.GetInitialHost`
- 删除空的 `ChatService` 实现类（DeepSeek、Doubao、MiniMax、Kimi、Ollama、Xunfei）
- `ChatFactory` 对未知提供商自动回退到 `ChatCompletionService`
- 减少样板代码，提升代码可读性

### 6) 设置页面优化

**图标按钮改进**：
- 主题切换按钮改为图标按钮（移除文字标签）
- 语言切换按钮改为图标按钮（移除文字标签）
- 更简洁的 UI，节省空间
- 保持功能完整性（悬停提示仍然显示）

**导航改进**：
- 设置页面标签从 `<button>` 改为 `<a>` 标签
- 支持右键菜单（在新标签页打开）
- 支持 `Ctrl/Cmd+Click` 在新标签页打开
- 改善无障碍体验（符合语义化 HTML）

**后退按钮修复**：
- 修复后退按钮始终返回首页的问题
- 正确使用浏览器历史记录
- 提升导航体验

---

## 🐛 问题修复

### 1) OpenAI 2.6.0 升级相关修复

**推理内容解析问题**：
- 修复升级到 OpenAI 2.6.0 后 `reasoning_content` 无法读取的问题
- 切换到自编译的 `Sdcb.OpenAI` 库（版本 2.6.0-alpha.3）
- 修复推理内容提取/解码问题
- 确保推理响应正确解析和显示

**依赖变更**：
- ❌ 删除 `OpenAI` 2.5.0（官方包）
- ✅ 新增 `Sdcb.OpenAI` 2.6.0-alpha.3（自编译包，修复推理内容支持）

### 2) OpenAI 客户端重试禁用

- 禁用 OpenAI 客户端的自动重试机制
- 避免长时间挂起和重复请求
- 提升错误处理的可预测性
- 改善用户体验（快速失败而非长时间等待）

### 3) OpenRouter 错误消息优化

- 优化 OpenRouter 错误消息的显示
- 提供更清晰的错误提示
- 帮助用户快速定位问题

### 4) 编译错误修复

- 修复用户模型权限页面导致的编译错误
- 修复 TypeScript 类型定义问题
- 确保代码库编译通过

---

## 🗄️ 数据库迁移

**迁移脚本位置**：
```
src/scripts/db-migration/1.8/1.8.1.sql
```

### 迁移内容

**清理 Azure AI Foundry URL**：
- 移除 `ModelKey.Host` 中的 `api-version` 查询参数
- 清理以 `/openai/v1?api-version=preview` 结尾的 URL
- 示例：
  - 之前：`https://xxx.openai.azure.com/openai/v1?api-version=preview`
  - 之后：`https://xxx.openai.azure.com/openai/v1`
- 仅影响 `ModelProviderId = 1`（Azure AI Foundry）的记录
- 包含验证输出（显示受影响的记录）

### 迁移特点

- **安全性**：自动检测并清理，不影响其他提供商
- **幂等性**：可重复执行（使用 `LIKE` 条件判断）
- **验证**：迁移后显示受影响的记录，便于确认

### 迁移步骤

1. **备份数据库**（建议）
2. **执行迁移脚本**：
   ```bash
   sqlcmd -S localhost -d Chats -i 1.8.1.sql
   ```
3. **验证迁移结果**：
   ```sql
   -- 检查 Azure AI Foundry 的 ModelKey Host
   SELECT Id, Name, Host, CreatedAt
   FROM ModelKey
   WHERE ModelProviderId = 1
     AND Host IS NOT NULL;
   ```

---

## 📊 代码统计

### 整体变更

- **提交数量**：29 次提交
- **主要变更**：用户模型权限管理、推理生命周期追踪、文件预览重构、聊天缓存优化

### 关键模块

**前端新增组件**：
- `ByUserTab.tsx` - 1,180 行（按用户管理模型权限）
- `UserModelTree.tsx` - 912 行（树形权限展示）
- `ModelUserList.tsx` - 506 行（从模型视角管理用户）
- `EditUserModelDialog.tsx` - 214 行（编辑用户模型权限对话框）
- `FilePreview.tsx` - 270 行（统一文件预览组件）
- `chatCache.ts` - 122 行（聊天列表缓存工具）

**前端重构**：
- `GeneralTab.tsx` - 主题/语言切换改为图标按钮
- `pages/admin/users/index.tsx` - 简化并移除冗余代码（-202 行净删除）
- `pages/admin/model/index.tsx` - 新增模型用户管理入口（+34 行）
- `types/adminApis.ts` - 新增用户模型管理相关 API 类型定义（+86 行）

**后端变更**：
- 新增 `TokenPony` 提供商（ID=19）
- `DBModelProvider.AzureOpenAI` → `DBModelProvider.AzureAIFoundry`
- `AzureChatCompletionService` → `AzureAIFoundryChatService`
- 移除空的 ChatService 实现类
- 简化 ChatService 构造函数参数
- 文件处理逻辑重构

**数据库**：
- 新增 1.8.1 迁移脚本（35 行）

**多语言支持**：
- 新增 TokenPony 相关翻译（zh-CN.json +35 行）
- 新增用户模型管理相关翻译

---

## 🚀 升级指南

### 从 1.8.0 升级到 1.8.1

1. **备份数据库**（建议）
2. **停止应用服务**
3. **执行数据库迁移**：
   ```bash
   sqlcmd -S localhost -d Chats -i 1.8.1.sql
   ```
4. **更新后端代码**
   - 注意：如果你有自定义的 Azure 相关代码，需要更新类名和枚举值
   - `AzureOpenAI` → `AzureAIFoundry`
   - `AzureChatCompletionService` → `AzureAIFoundryChatService`
5. **更新前端代码**
   - 更新 `DBModelProvider` 枚举引用
6. **启动应用服务**
7. **验证功能**：
   - 测试 Azure AI Foundry 模型是否正常工作
   - 测试用户模型权限管理功能
   - 测试文件预览功能
   - 测试推理模型的自动折叠功能
   - 验证聊天列表缓存是否生效

### 新功能使用说明

**用户模型权限管理**：
1. 进入 `/admin/user-models` 页面
2. 在用户列表中选择要管理的用户
3. 在树形结构中勾选/取消勾选模型权限
4. 点击"保存更改"应用权限变更
5. 或者，从模型页面点击"用户权限"按钮，查看和管理特定模型的用户访问权限

**聊天列表缓存**：
- 自动启用，无需配置
- 首次访问会缓存聊天列表到浏览器本地存储
- 后续访问会先从缓存加载，然后更新
- 登出时自动清除缓存

**文件预览**：
- 上传文件后会自动显示预览
- 图片类型：直接显示缩略图，点击可全屏预览
- 视频/音频：显示播放器
- 文档：显示文件图标 + 文件名 + 下载按钮

---

## ⚠️ 破坏性变更

### 1. Azure 品牌变更

**影响范围**：
- 枚举值 `DBModelProvider.AzureOpenAI` 改名为 `DBModelProvider.AzureAIFoundry`
- 枚举数值保持不变（仍为 1）
- 前端和后端都需要更新引用

**迁移方法**：
```typescript
// 之前
if (modelProviderId === DBModelProvider.AzureOpenAI) { ... }

// 之后
if (modelProviderId === DBModelProvider.AzureAIFoundry) { ... }
```

**数据库影响**：
- 无需数据库迁移（枚举值未变）
- 只是代码层面的重命名

### 2. ChatService 构造函数变更

**影响范围**：
- 移除了所有 `ChatService` 构造函数中的 `suggestedApiUrl` 参数
- 如果你有自定义的 ChatService 实现，需要更新构造函数签名

**迁移方法**：
```csharp
// 之前
public class MyChatService(Model model, string suggestedApiUrl) 
    : ChatCompletionService(model, suggestedApiUrl) { }

// 之后
public class MyChatService(Model model) 
    : ChatCompletionService(model) { }
```

---

## 🎓 学习资源

### 相关文档

- 📖 [1.8.0 发布说明](./1.8.0.md) - 了解上一个版本的重大架构变更
- 📖 [1.8.0 API 变更说明](../1.8.0-api-changes.md) - 详细的 API 接口变更
- 📖 [构建文档](../build.md) - 如何构建和部署
- ☁️ [Azure 部署文档](../azure-bicep.md) - 如何部署到 Azure

### 社区支持

- 🐛 [报告问题](https://github.com/sdcb/chats/issues)
- 💬 [参与讨论](https://github.com/sdcb/chats/discussions)
- 📧 联系作者：[https://github.com/sdcb](https://github.com/sdcb)

---

## 🙏 贡献者

感谢所有为本版本做出贡献的开发者！

特别感谢：
- [@sdcb](https://github.com/sdcb) - 用户模型权限管理、推理生命周期追踪、文件预览重构、聊天缓存优化、Azure 品牌升级、TokenPony 提供商、OpenAI 2.6.0 升级修复

如有问题或建议，欢迎在 [GitHub Issues](https://github.com/sdcb/chats/issues) 反馈。

---

## 📝 更新日志摘要

### 新增功能

- ✅ 用户模型权限管理系统（按用户和按模型双视角）
- ✅ 推理内容生命周期追踪与自动折叠
- ✅ 文件预览组件重构（统一体验 + 多文件类型支持）
- ✅ 聊天列表缓存（localStorage + 24 小时过期）
- ✅ TokenPony 提供商支持（ID=19）
- ✅ 新建聊天按钮加载状态

### 架构改进

- ✅ Azure OpenAI 品牌升级为 Azure AI Foundry
- ✅ ChatService 架构简化（移除 suggestedApiUrl 参数）
- ✅ 文件处理逻辑从 Controller 移至 Service 层
- ✅ 删除空的 ChatService 实现类
- ✅ Azure URL 自动转换逻辑统一

### UI/UX 优化

- ✅ 提供商选择器改为图标网格布局
- ✅ 主题/语言切换改为图标按钮
- ✅ 深色主题下图标背景修复
- ✅ 后退按钮行为修复
- ✅ 导航链接支持右键菜单和新标签页打开

### 问题修复

- ✅ 修复 OpenAI 2.6.0 升级导致的推理内容解析问题
- ✅ 禁用 OpenAI 客户端自动重试
- ✅ 优化 OpenRouter 错误消息
- ✅ 修复 gemini-2.0-flash-exp 文件支持问题
- ✅ 修复编译错误

### 数据库迁移

- ✅ 清理 Azure AI Foundry ModelKey Host 中的 api-version 参数

### 代码清理

- ✅ 删除 GeneratedImageSize 和 KnownImageSize 类
- ✅ 删除冗余的 ChatService 实现
- ✅ 简化用户管理页面代码（-202 行）

---

## 🔮 后续计划

### 1.8.x 系列

- 用户模型权限批量导入/导出
- 模型使用情况统计（按用户、按模型）
- 文件管理优化（批量删除、容量统计）
- 推理内容摘要功能

### 未来版本

- 多租户支持（组织/团队管理）
- 更细粒度的权限控制（读/写/管理）
- 模型使用配额管理
- 审计日志系统

---

<p align="center">
  <sub>最后更新：2025-11-11</sub>
</p>
