<!-- Language: zh-CN -->
<p align="right"><a href="../../en-US/release-notes/1.4.md">English</a> | <b>简体中文</b></p>

# Chats 1.4.0 发布说明

> 发布日期：2024-05-20

1.4.0 版本主要围绕 API 功能增强展开，核心亮点包括全面的函数调用（Function Call）支持、API 缓存功能以及 Google Gemini 模型的代码执行能力。此外还包含多项性能优化和问题修复。

## 亮点概览

- **全面的函数调用支持**：所有 API 接口均支持函数调用（Function Call），包括通用 OpenAI 兼容的聊天补全 API、Google Gemini API 和 Azure OpenAI Response API
- **API 缓存功能**：新增缓存特性，使用 `/v1-cached` 或 `/v1-cached-createOnly` 地址，性能显著优化
- **Google Gemini 代码执行**：Google Gemini 模型现已支持代码执行功能
- **性能优化**：多项 API 性能优化，包括异步处理、减少重复数据库调用等

---

## 新功能与改进详情

### 1) 函数调用（Tool Call）全面支持

本版本实现了跨所有 API 端点的函数调用支持：

**OpenAI 兼容 API**
- 通用聊天补全 API (`/v1/chat/completions`) 完整支持工具调用
- 新增 `ToolCallSegment` 类型，用于流式响应中的工具调用片段
- 优化函数调用响应逻辑，确保首次响应时机正确

**Google AI / Gemini API**
- Google AI 现已支持工具调用（Tool Call）
- Google Gemini 模型新增代码执行（Code Execution）功能
- 工具调用与代码执行均可在聊天补全流程中无缝使用

**Azure OpenAI Response API**
- Response API 也已支持工具调用
- 经过测试确认 Response API 工作正常
- 修复了推理内容不显示的问题

### 2) API 缓存功能

为提升 API 性能和降低成本，新增了用户级 API 缓存机制：

**缓存端点**
- `/v1-cached`：启用缓存的聊天补全端点
- `/v1-cached-createOnly`：仅创建缓存的聊天补全端点

**缓存特性**
- 新增 `UserApiCache` 实体，用于存储用户 API 请求缓存
- 缓存系统支持工具调用场景
- 新增缓存指标（Cache Metrics），便于监控缓存效果
- 缓存用量异步保存，避免阻塞主流程

**性能提升**
- 避免重复的身份验证数据库调用
- 客户端信息异步获取，优化 API 响应速度
- 多项缓存性能优化，显著提升 API 吞吐量

### 3) 日志与监控改进

**日志优化**
- 忽略 OpenAI 兼容控制器的常规日志输出
- 抑制 o3/o4-mini 模型的错误日志
- 新增必要的警告提示

**监控增强**
- 新增缓存指标统计
- 完善工具调用过程的可观测性

### 4) 用户体验优化

**消息处理**
- 在完整聊天补全中添加合并逻辑
- 修复推理内容不显示的问题
- 优化首次响应时机

**兼容性**
- 提升与各类模型提供商的兼容性
- 确保工具调用在不同场景下正常工作

---

## 技术细节

### 新增实体与类型

- `UserApiCache`：用户 API 缓存实体
- `ToolCallSegment`：工具调用片段类型

### API 端点变更

- 新增：`/v1-cached` - 启用缓存的聊天补全
- 新增：`/v1-cached-createOnly` - 仅创建缓存的聊天补全

### 数据库变更

- 新增 `UserApiCache` 相关表结构
- 缓存用量统计字段

---

## 升级注意事项

1. **缓存功能**：如需使用 API 缓存功能，请使用新的 `/v1-cached` 或 `/v1-cached-createOnly` 端点
2. **工具调用**：所有 API 现已支持函数调用，无需特殊配置
3. **性能提升**：本版本包含多项性能优化，升级后 API 响应速度将有明显提升

---

## 已知问题与限制

- 缓存功能为实验性特性，建议在生产环境使用前充分测试
- Google Gemini 代码执行功能需要模型本身支持

---

## 完整变更列表

查看完整的提交历史：[1.3.1.794...1.4.0.815](https://github.com/sdcb/chats/compare/1.3.1.794...1.4.0.815)

主要提交：
- suppress o3/o4-mini error log
- confirmed response api works
- google gemini supports code execution
- correct function call response logic
- correct first response tick
- google ai now supports tool call
- response api also supports tool call
- fix reasoning content not show issue
- save cache usage in async way
- avoid duplicated authentication db call for api
- add cache metrics
- optimize performance by async client info call
- cache also supports tool call
- confirmed cache working
- implement cache support
- initial commit of google ai tool
- Add merge logic in full chat completion
- add ToolCallSegment
- initial commit of UserApiCache
