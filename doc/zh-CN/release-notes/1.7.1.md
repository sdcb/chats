<!-- Language: zh-CN -->
<p><a href="./README.md">📋 所有版本</a> <span style="float:right"><a href="../../en-US/release-notes/1.7.1.md">English</a> | <b>简体中文</b></span></p>

# Chats 1.7.1 发布说明

> 发布日期：2025-10-13（相对 1.7.0 以来 52 次提交）

1.7.1 是一次重要的体验优化与功能增强版本，核心聚焦于安全审计、发送体验、工具调用展示、性能优化及大量前端 UI/UX 改进，同时修复了多个关键问题。

## 亮点概览

- 新增安全审计日志管理：完整的登录尝试记录与速率限制监控
- 全新发送按钮体验：支持多种发送模式（发送、继续、重新生成）与移动端适配
- 工具调用展示优化：独立的 `ToolCallBlock` 组件，更清晰的参数与结果展示
- 生成信息按需加载：优化性能，减少初始加载时间
- 聊天输入体验提升：暂停按钮、自动隐藏、图标布局优化、全屏模式改进
- 管理后台增强：消息内容查询、用户用量统计优化、模型图标统一
- 移动端优化：更好的响应式布局与触控体验

---

## 新功能与改进详情

### 1) 安全审计日志管理（需要数据库迁移）

后端新增完整的安全审计功能：
- 新增数据表：`PasswordAttempt`、`KeycloakAttempt`，为 `SmsAttempt` 添加索引
- 新增 `SecurityLogsController`：提供密码、短信、Keycloak 登录尝试的查询接口
- 数据传输对象：`KeycloakAttemptDto`、`PasswordAttemptDto`、`SmsAttemptDto`、`SecurityLogQuery`
- 登录速率限制审计：记录所有登录尝试（成功/失败）及速率限制触发情况

前端新增安全日志页面：
- 路径：`/admin/security-logs`
- 三个独立面板：Keycloak 登录、密码登录、短信登录
- 支持时区选择、时间范围筛选、IP 地址查询
- 分页展示，状态可视化（成功/失败/速率限制）
- 新增 1200+ 行代码，完整的安全事件可观测性

### 2) 发送按钮体验升级

全新设计的发送按钮组件（`send-button.tsx`）：
- 三种发送模式：
  - **发送**（Send）：发送新消息
  - **继续**（Continue）：继续未完成的对话
  - **重新生成**（Regenerate）：重新生成最后一条消息
- 下拉菜单支持模式切换
- 移动端自适应：触控友好，尺寸优化
- 快捷键支持：`Ctrl+Enter` / `Cmd+Enter`
- 禁用状态逻辑优化，实时响应 `sendMode` 状态

配套 Hook：
- `useSendMode`：统一管理发送模式状态与事件监听

### 3) 工具调用展示优化

新增 `ToolCallBlock` 组件：
- 独立的工具调用可视化组件
- 清晰展示工具名称、参数、执行结果
- 支持折叠/展开，优化长参数/结果的展示
- 与 Markdown 渲染分离，避免混淆
- 优化工具名称显示（`optimize tool call name`）

流式工具调用改进：
- 确保停止按钮正常工作（`ensure stop works`）
- 工具调用过程中的状态提示更清晰

### 4) 生成信息按需加载

性能优化，减少初始加载压力：
- 后端新增独立接口：
  - `GET /api/chats/messages/{turnId}/generate-info`（用户端）
  - `GET /api/admin/messages/{turnId}/generate-info`（管理端）
  - `GET /api/shared-chats/{chatId}/turns/{turnId}/generate-info`（分享页）
- 前端组件重构：
  - `GenerateInformationAction` 支持按需加载
  - 新增缓存机制（`generateInfoCache.ts`）
  - 修复刷新后推理时间为 0 的问题
- 新增数据传输对象：`StepGenerateInfoDto`、`TurnGenerateInfoDto`
- 从 `TurnDto` 中分离生成信息，减少 49 行冗余

### 5) 聊天输入体验提升

多项输入框改进：
- **暂停按钮**：生成过程中支持暂停/继续
- **自动隐藏输入框**：生成时自动收起，节省屏幕空间（`auto hide chatinput when chatting`）
- **图标布局优化**：
  - 输入框图标在同一行排列（`ChatInput position icons in same row`）
  - 缩短输入框头部高度（`make the chatInput header a little bit shorter`）
  - 发送按钮不占用独立一行（`send button don't taken 1 line in ChatInput`）
  - 发送按钮更小，90% 不透明度（`make send button smaller and have 90% opacity`）
- **折叠管理**：支持输入框折叠状态管理（`manage chatInput collapse`）
- **全屏模式**：全屏时也显示工具列表（`fullscreen mode also show tools`）
- **非视觉模型隐藏上传按钮**：非视觉模型隐藏远程图片上传按钮（`hide upload remote image button for non-vision model`）
- **移动端优化**：从图库选择图片支持（`allow select from galary in mobile`）

滚动行为优化：
- 生成过程中滚动后不再自动锁定到底部（`don't lock to bottom when generating after any scroll up`）

### 6) 管理后台增强

消息管理：
- 新增消息内容查询功能（`admin message add message content query`）
- 使用 `pushState` 优化消息列表路由（`use pushState for admin message list`）

用户用量统计：
- 使用统一的 `ModelProviderIcon` 组件（`use ModelProviderIcon for user usage tab`）

模型图标统一：
- 重构 `ChatIcon` 为 `ModelProviderIcon`，统一各处模型图标展示
- 支持模型提供商名称显示（`ChatIcon support model provider name`）
- 用于：聊天头部、对话列表、管理页、用量统计等

分页组件优化：
- 优化 7 页以内的分页显示（`optimize pagination component for 7 pages`）
- 重命名 `Pagiation.tsx` → `Pagination.tsx`（修正拼写）

### 7) 模型管理 UI 优化

模型页面重构：
- 图标操作按钮统一（`refactor model page icon`）
- 新增 `IconActionButton` 公共组件
- 可折叠面板改进（`CollapsiblePanel`）
- 修复拖拽/放置问题（`fix drag/drog in model page, optimize mobile UI`）
- 移动端 UI 优化

删除弹窗重构：
- 统一 `deletePopover` 组件（`refactor deletePopover`）

### 8) 聊天体验优化

头部优化：
- 模型头部 UI 优化（`model header ui optimize`）
- 聊天头部布局调整（`ChatHeader` 重构）

侧边栏优化：
- 侧面板支持多图标显示（`add several usage position buttons to ChatInput`）

消息展示：
- 修复边界情况的消息显示问题（`fix edge case message display issue`）
- 修复空轮次问题（`fix empty turn issue, less unknown error`）
- 消息头部添加模型提示（`add model tooltip to conversation/admin messages`）
- 响应消息添加骨架屏（`add skeleton for response message`）

预设管理：
- 为 `ChatPresetList` 添加拖拽手柄（`add drag handle to ChatPresetList`）
- 修复预设列表拖拽跳跃问题（`fix chatpresetList drag jump issue`）
- 新增预设重置对话框（`introduce ChatPresetResetDialog`）

### 9) 问题修复

编译错误修复：
- 多次 FE 编译错误修复（`fix FE compilation error` × 2）
- 修复编译错误（`fix compile error`）

功能修复：
- 修复 gpt-image-1 问题（`fix gpt-image-1 issue`）
- 修复聊天更新标题问题（`fix chat update title issue`）
- 修复日历组件（`fix canlendar component`）
- 修复刷新后推理时间始终为 0 的问题（`fix: reasoning time is always 0 after refresh`）
- 修复移动端生成信息弹窗（`fix mobile generate information popover`）
- 修正首次 Token 延迟统计（`correct first token latency`）

UI 修复：
- 修复 F12 控制台警告（`fix a F12 warning for IconReasoning.tsx`）
- 修复初始化问题（`fix init issue`）
- 清理 console.log（`drop console.log`）

### 10) 代码质量与维护

组件迁移：
- 安全日志组件移至正确的文件夹（`security log components move to correct component folder`）
- 删除未使用的图标（`delete non-used icons`）：
  - `IconAddress`、`IconCreditCard`、`IconEraser`、`IconError`
  - `IconMessageCirclePlus`、`IconMessageShare`、`IconMinus`、`IconSend`

国际化：
- 移除 `en.json`，统一使用 `zh-CN.json`（`remove en.json`）

构建优化：
- 删除不必要的 release webhook 配置（`don't need release webhook yml`）
- 前端脚手架使用最新版本（`scaffold fe use latest`）

### 11) 移动端优化

- 用户管理页面移动端优化（`mobile optimize for user managment page`）
- 用户页面新增编辑按钮（`add user page edit button`）
- 模型管理页移动端 UI 优化
- 发送按钮移动端支持

---

## API 变化

新增接口：
- 安全审计日志：
  - `GET /api/admin/security-logs/keycloak-attempts`
  - `GET /api/admin/security-logs/password-attempts`
  - `GET /api/admin/security-logs/sms-attempts`
- 生成信息按需加载：
  - `GET /api/chats/messages/{turnId}/generate-info`
  - `GET /api/admin/messages/{turnId}/generate-info`
  - `GET /api/shared-chats/{chatId}/turns/{turnId}/generate-info`
- 消息管理：
  - `GET /api/admin/messages` 新增 `content` 查询参数

---

## 破坏性变更

本版本无破坏性变更，但**必须执行数据库迁移脚本**才能使用安全审计功能。

---

## 升级指南（务必执行数据库迁移）

1. **备份数据库**（强烈建议）
2. **执行数据库迁移脚本**（仅 SQL Server）：
   - 脚本路径：`src/scripts/db-migration/1.7/20250925-rate-limit.sql`
   - 此脚本创建 `PasswordAttempt`、`KeycloakAttempt` 表
   - 为 `SmsAttempt` 表添加必要索引
   - 不执行此脚本将导致安全审计功能无法使用，系统可能报错
   - **⚠️ 重要说明**：
     - 该迁移脚本**仅支持 SQL Server**
     - **SQLite / PostgreSQL 用户**：需参考该脚本自行编写对应数据库的迁移语句
     - 或者选择**全新安装**（全新安装会自动创建所有必需的表）
3. 后端重新构建与部署
4. 前端建议删除 `src/FE/node_modules` 后重新安装依赖并构建
5. 以管理员身份登录，前往「设置 → 安全日志」查看新增功能

---

## 性能改进

- 生成信息按需加载，减少初始加载时间
- 新增缓存机制（`generateInfoCache.ts`），避免重复请求
- 分页组件优化，提升大数据量场景的性能

---

## 已知提示

- 安全审计日志需要后端配置相应的日志记录，默认已启用
- 发送按钮的快捷键可能与部分浏览器扩展冲突，可通过下拉菜单切换模式

---

## 致谢

- 感谢所有反馈问题与建议的用户！

---

如对本版本有任何问题或建议，欢迎在仓库提交 Issue 或 PR。祝使用愉快！
