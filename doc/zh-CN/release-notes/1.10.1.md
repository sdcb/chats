<!-- Language: zh-CN -->
<p><a href="./README.md">📋 所有版本</a> <span style="float:right"><a href="../../en-US/release-notes/1.10.1.md">English</a> | <b>简体中文</b></span></p>

# Chats 1.10.1 发布说明

> 发布日期：2026-02-15（相对 main 以来 82 次提交）

1.10.1 是 1.10.0 之后的一次功能迭代与体验优化版本。重点围绕 **沙箱管理器（Sandbox Manager）** 全面增强、**服务端 ETag 缓存**、**ChatMiniMap 导航组件**、**API Key 管理改进**、**文件下载体验优化** 以及大量 UI/UX 改善展开。后端同步进行了 `ThinkTagParser` 重写、`HttpClient` 统一注入、Docker 会话模型重构等工程改进。

## 🎯 核心功能

### 1) 沙箱管理器（Sandbox Manager）全面增强

- 🏷️ **重命名**：`Session Manager` 正式更名为 `Sandbox Manager`（沙箱管理），命名更准确。
- 📋 **会话信息卡片**：新增 `SessionInfoCard` 组件，展示镜像名称、CPU/内存/进程数限制、网络模式、IP 地址、创建/到期时间、剩余时间等详细信息，支持触控刷新会话时间。
- 🌍 **环境变量管理**：新增 `SessionEnvVarEditor`，支持表格模式和原始文本模式双向编辑用户环境变量，含验证、去重检测、未保存变更提示。后端新增 `GET/PUT /{encryptedSessionId}/environment-variables` 接口。
- 📂 **文件管理优化**：改用 `ls -la --full-time` 命令代替 `tar` 下载归档来列目录，大幅提升 Docker 文件浏览性能；新增 `DockerOutputParser` 解析 Linux/Windows 目录列表。引入文件内文本编辑器，支持修改检测与放弃确认。
- 🗑️ **删除 Session**：新增删除 Docker Session 端点与前端确认操作。
- 🔗 **OwnerChatId 关联**：`ChatDockerSession` 新增 `OwnerChatId` 字段直接关联 Chat，允许在无消息轮次时就创建 Session。
- 📊 **Tab 式布局**：管理窗口改为 Info / Env / Command / Files / Editor 五 Tab 布局，切换后保持状态。
- 🐳 **拉取进度**：拉取 Docker 镜像时显示实时进度。
- 🛠️ **多项 Bug 修复**：修复 Session 销毁后数据库未标记终止、文件列表双重加载、拖拽上传失效、下载路径错误等问题。
- 📦 **默认镜像策略更新**：`CodeInterpreter:DefaultImage` 默认值更新为 `sdcb/code-interpreter:latest`，新建会话默认使用最新镜像。

### 2) 服务端 ETag 缓存

- ⚡ **EtagCacheHelper**：引入基于 `XxHash128` 的服务端 ETag 生成机制，当数据未变化时返回 `304 Not Modified`，减少不必要的数据传输。
- 📡 **应用范围**：已应用于 `GET /api/models`、`GET /api/prompts`（brief/default）、`GET /api/messages/{chatId}`、`GET /api/user-chats/groups` 等高频接口。
- 🗑️ **移除前端缓存**：删除 `chatCache.ts`（174 行），移除前端 `localStorage` 聊天列表缓存，改由服务端 ETag 驱动，逻辑更简洁、数据更一致。

### 3) ChatMiniMap 导航组件

- 🗺️ **新增 `ChatMiniMap`**：在聊天视图右侧提供消息缩略导航，通过色块直观展示用户/助手消息分布，支持点击跳转到指定消息。
- ⬆️⬇️ **滚动控制迁移**：原 `ChatInput` 中的"滚动到顶部/底部/上一条用户消息"按钮移至 `ChatMiniMap`，ChatInput 更聚焦于输入功能。

### 4) API Key 管理改进

- 🔐 **创建流程优化**：新增 `ApiKeyDialog` 对话框，支持自定义名称和过期时间；创建成功后仅一次性显示完整 Key，之后列表中仅展示脱敏值。
- ✏️ **编辑功能**：支持修改 API Key 的备注和过期时间。
- 📋 **批量复制**：新增一键复制所有 Key 功能。
- 🔒 **后端安全**：列表接口不再返回完整 Key（`ToMasked()`），创建接口接受 `CreateApiKeyDto`（含 `comment`、`expires`）。

### 5) 文件下载体验优化

- 📎 **Content-Disposition 支持**：所有文件服务（阿里云 OSS / AWS S3 / Azure Blob / 本地存储）下载时均携带原始文件名，浏览器可直接以原始文件名保存。
- 🔧 **本地文件服务修复**：修复本地文件服务下载时 Content-Disposition 缺失的问题。

---

## 🏗️ 架构与工程

### 1) ThinkTagParser 重写

- 重写 think-tag 解析器，从基于原始 `string` token 流改为基于 `ChatSegment` 流：非文本 Segment（如工具调用）直接透传，无需特殊处理；简化了 `ChatService` 集成逻辑。
- 新增 `ThinkTagParserTests` 单元测试覆盖各种边缘用例。

### 2) HttpClient 统一注入

- 后端所有 `HttpClient` 使用改为通过 `IHttpClientFactory` 注入（包括 `ImageChatSegment`、`ImageGenerationService` 等），避免 Socket 耗尽问题。

### 3) Code Interpreter 镜像流水线增强

- 镜像构建新增 `RUN_NUMBER` 注入，并写入容器环境变量；`skills.md` 头部增加 `rv` 构建标识，便于定位镜像来源。
- 镜像预装工具新增 `ripgrep (rg)`，提升代码与文本搜索效率。
- CI 工作流放开限制：非 main 分支也会创建并推送 `latest` manifest，便于分支快速验证最新镜像。

### 4) Docker 服务接口重构

- `IDockerService` 接口简化：移除 `WrapDockerOperationAsync`、将 `ListDirectoryAsync` 提升为接口默认实现（基于 `ExecuteCommandAsync`）、移除冗余异常类（`Exceptions.cs`）。
- 所有 Docker Session API 端点改用加密 Session ID（`encryptedSessionId`）替代裸 `sessionId`。
- 新增 `BytesFormatter` 用于资源量格式化显示。

### 5) 管理后台 API 整合

- 合并管理员/用户生成信息查看路径：统一通过 `GET /api/messages/{chatId}` 获取，移除独立的管理员 turn info 端点（`AdminMessageController` 精简）。

### 6) Keycloak 重构

- 新增独立的 `KeycloakOAuthClient` 类，将 OAuth 逻辑从配置对象中抽离，提升可测试性。

---

## 🎨 前端体验优化

### ChatInput 重构

- 文件上传按钮收纳至 `+` 弹出菜单，输入区更简洁。
- 新增 `CodeExecutionControl` 组件：可一键为所有模型批量切换代码执行开关，集成 Docker 图标快速打开沙箱管理。
- Agent 链接移至 ChatInput 底部。
- 输入框颜色微调，增加区分度。

### ChatMessage 优化

- 删除消息时按钮显示 loading 状态，防止重复操作。
- 新增 `ExpandTextAction` 组件，支持长消息展开/折叠。
- 助手消息自动最小高度机制，改善滚动时的视觉跳动。
- 移除 `requestAnimationFrame` 调用（3 处），简化渲染逻辑。
- 发送消息/选择对话时自动将用户消息滚动到顶部，底部增加自适应留白。
- 工具调用块在后续内容出现时自动折叠。

### 设置页面

- 主题/语言选择器改为 `SegmentedControl` 分段控件，更紧凑。
- 新增**字体大小设置**（12–18px 滑块 + 输入框），保存到 `localStorage` 并通过 CSS 变量 `--chat-font-size` 实时生效。

### 文件服务管理

- 配置信息默认脱敏展示（`maskJsonValues`），编辑时切换为明文。
- 新增**验证**按钮，可在保存前测试文件服务配置的连通性。
- 添加按钮样式与模型管理页面保持一致。

### 费用显示优化

- 移除费用展示中的人民币符号 `￥`，简化为数值展示，适应多币种场景。

### 其他

- 默认发送模式从 `Enter` 改为 `Ctrl+Enter`。
- 修复刷新页面时 `Maximum update depth exceeded` 错误。
- 修复 ChatInput 高度覆盖 ChatMessage 区域的回归问题。
- 修复微信浏览器 UserAgent 字段过长导致的问题（扩展字段长度至 500）。
- 消息管理页面用户查询搜索增加防抖。
- 升级 `baseline-browser-mapping` 到 2.9.19。

---

## 🐛 修复与稳定性

- 修复 16 个因 EF Core `ExecuteUpdateAsync` 在 InMemory Provider 不支持导致的单元测试失败。
- 修复 Docker Session 销毁后数据库未标记终止的 Bug。
- 修复文件列表双重加载问题。
- 修复拖拽上传 Bug。
- 修复中文字符同步异常问题。

---

## ⬆️ 升级提示

- 运行数据库迁移脚本：`src/scripts/db-migration/1.10/1.10.1.sql`
  - 扩展 `ClientUserAgent.UserAgent` 字段长度至 500
  - `ChatDockerSession` 新增 `OwnerChatId` 列、外键与索引，并自动从 `OwnerTurnId` 迁移数据
- 默认配置已更新：`CodePod:OutputOptions:MaxOutputBytes` 由 `6144 (6KB)` 提升至 `8192 (8KB)`，如有自定义值请按需核对。
