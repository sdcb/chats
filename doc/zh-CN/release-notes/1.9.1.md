<!-- Language: zh-CN -->
<p><a href="./README.md">📋 所有版本</a> <span style="float:right"><a href="../../en-US/release-notes/1.9.1.md">English</a> | <b>简体中文</b></span></p>

# Chats 1.9.1 发布说明

> 发布日期：2025-12-21（相对 1.9.0 以来 77 次提交）

1.9.1 是一次重要的功能增强和稳定性更新，核心亮点包括**小米 MiMo 模型提供商支持**、**Prompt Cache Token 计费**、**Next.js 16 与 React 19 升级**、**交错思考（Interleaved Thinking）支持**以及**全新的 4 级聊天视图架构**。此版本还移除了对 OpenAI .NET SDK 和 Mscc.GenerativeAI 的依赖，改用原生 HttpClient 实现更好的可控性。

## 🎯 核心功能

### 1) 小米 MiMo 模型提供商

**新增小米 MiMo 提供商**（ID=21）：
- 支持小米 MiMo-V2-Flash 大模型
- 同时支持 OpenAI Chat Completions API 和 Anthropic Messages API 格式调用
- 支持思维链（Thinking）功能
- 新增 `xiaomi.png` 图标（自托管）
- 为Mimo引入`MimoInterleavedToolCallTransformer`，支持在 `Claude Code` 等工具中支持交错思考工具调用

**后端实现**：
- `MimoChatService.cs` - OpenAI 格式调用实现
- `MimoAnthropicService.cs` - Anthropic 格式调用实现
- 修复非流式 API 调用时 tool 属性为 null 的问题

### 2) Prompt Cache Token 支持

**缓存计费功能**：
- 新增 Prompt Cache Token 价格配置（适用于 Anthropic 等支持缓存的模型）
- 模型价格区分 Fresh Token 和 Cached Token
- 在生成信息中显示缓存 token 使用量
- Anthropic API 返回 `CacheCreationTokens` 和 `CacheReadTokens`

**数据库变更**：
- `Model.InputTokenPrice1M` 重命名为 `InputFreshTokenPrice1M`
- 新增 `Model.InputCachedTokenPrice1M` 列
- `UserModelUsage` 表支持分别统计 Fresh/Cached Token 用量和费用

### 3) 交错思考（Interleaved Thinking）支持

**支持的模型提供商**：
- Minimax - 支持 Chat Completions API 格式的交错思考
- DeepSeek - 支持 Chat Completions API 格式的交错思考
- 修复 DeepSeek-R1 thinking signature 非 base64 格式问题

**技术实现**：
- `MiniMaxChatService.cs` - Minimax 专用聊天服务（126 行）
- `DeepSeekChatService.cs` - DeepSeek 专用聊天服务（46 行）
- `ChatCompletionService.cs` 增强交错思考消息解析

### 4) 4 级聊天视图架构

**架构重构**：
- 引入 chat/turn/step/content 四级结构
- 更清晰地展示对话流程和生成信息
- 使用生成信息气泡替代 StepDivider
- 思维消息时长从 step 获取更准确的时间

**前端改进**：
- 重构 `ChatView.tsx` 支持新架构
- 更新 `ResponseMessage.tsx` 支持多级内容展示
- 优化生成信息缓存逻辑

### 5) LaTeX 公式复制功能

**新增功能**：
- LaTeX 公式支持一键复制原始公式代码
- 引入 `rehypeKatexWithCopy.ts` 自定义 rehype 插件
- 新增 `useMathCopy.ts` hook 处理复制交互

---

## 🏗️ 架构改进

### 1) 前端框架升级

**Next.js 升级**（15.5.3 → 16.0.7）：
- 迁移到新的 ESLint 配置格式（`eslint.config.js`）
- 更新页面和组件以适配新 API
- 修复大量由升级引起的兼容性问题

**React 升级**（18.2.0 → 19.2.1）：
- 适配 React 19 新特性
- 修复 `ChatModelDropdownMenu` 闪烁问题
- 修复 `ChatPresetModal` 控制台错误
- 修复 MCP 标签在模型设置对话框不显示的问题

**依赖更新**：
- 升级所有 `@radix-ui` 包到最新版本
- 执行 `npm audit fix`，升级 Next.js 安全补丁

### 2) 后端 SDK 清理

**移除 OpenAI .NET SDK**：
- 删除 `Azure.AI.OpenAI` 依赖
- 改用原生 `HttpClient` 实现 Chat Completions API
- 修复由迁移引起的 token 统计和工具调用问题

**移除 Mscc.GenerativeAI**：
- 删除 `Mscc.GenerativeAI` 依赖
- 重写 `GoogleAI2ChatService.cs`（+607 行）使用原生 HttpClient
- 更好地支持 Gemini 3 系列模型
- 修复 Gemini 图片生成 API 边界情况

### 3) 异常处理统一

- 统一 ChatService 异常为 `RawChatServiceException` 和 `ChatServiceException`
- 优化错误信息展示，显示完整 JSON 而非仅消息
- 优化非异步模型的 Response API 错误处理

### 4) Signature 存储格式变更

- `StepContentThink.Signature` 从二进制的 `varbinary` 改为字符串形式
- 现在按原样（无论是base64/guid还是其它形式）文本格式存储，便于处理 DeepSeek-R1 等非标准格式

---

## 🐛 问题修复

### 1) 模型服务修复

- 修复 DeepSeek-R1 thinking signature 非 base64 格式导致的解析问题
- 修复用户中途停止聊天时 prompt token 未正确统计的问题
- 修复 Response API 工具调用问题
- 修复 Gemini 无工具调用时签名处理问题（更好支持 Gemini 3）
- 修复 TokenPony 支持 deepseek-v3.* 模型的 thinking 功能
- chat completions api的web chat场景中指定 `parallel_tool_calls`

### 2) 图片生成修复

- 修复生成图片始终为矩形的问题
- 修复 gpt-image-1.5 模型支持
- 修复 Gemini 图片生成 API 在某些边界情况下失败的问题

### 3) 前端修复

- 修复 `ChatModelDropdownMenu` 组件闪烁问题（React/Next.js 升级导致）
- 修复 MCP 标签在聊天头部模型设置对话框不显示的问题
- 修复 `ChatPresetModal` 在 F12 控制台显示 React 错误的问题
- 修复刷新页面时未显示正确的最后消息的问题
- 修复页面刷新时自动滚动到最后消息
- 修复 `_error.tsx` 导致的前端构建警告

### 4) API 修复

- 修复 `{turnId}/{contentId}/text-and-save-new` 接口 HTTP 500 错误
- 修复 Google AI 列出模型功能
- 修复使用量页面 API Key 格式显示问题
- 强制使用量页面从 URL 获取单一数据源

---

## 💄 UI/UX 优化

### 1) 登录页改进

- 新增版本号显示
- 优化小屏幕（手机）副标题字体大小
- 移除未注册的 TM 符号，保留 © 版权符号

### 2) 错误展示优化

- 使用等宽字体显示错误信息
- 优化暗色主题下的错误颜色
- 显示完整错误 JSON 而非仅消息

### 3) 聊天界面优化

- 使用生成信息气泡替代 StepDivider 显示步骤使用信息
- 思维消息时长从 step 获取更准确的时间
- 简化 ChatSegment 组件
- 删除未使用的 `alert.tsx` 组件

---

## 🔧 其他改进

### 1) 测试与质量

- 添加 Google Gemini 单元测试
- 添加 DeepSeek Chat Service 测试
- 添加 Minimax Chat Service 测试
- 修复 FiddlerHttpDump 测试
- 添加 dump request 断言

### 2) 安全与规范

- 为所有 HttpClient 请求添加 UserAgent
- 修复 Mimo 模型不需要 Authorization Bearer 的 API Key 头问题

### 3) 构建与部署

- 优化 CI 缓存触发策略
- 将版本号从 window 全局变量移至环境变量
- 为所有模型提供商添加引入日期字段

### 4) 文档

- 将 Release Notes 移至 README.md 顶部
- 为 Release Notes 添加图标

---

## 🗄️ 数据库迁移

**迁移脚本位置**：
```
src/scripts/db-migration/1.9/1.9.1.sql
```

### 迁移内容

**Step 1：Model 表价格字段改名与新增缓存价格**
- `InputTokenPrice1M` 重命名为 `InputFreshTokenPrice1M`
- 新增 `InputCachedTokenPrice1M` 列（初始值等于 `InputFreshTokenPrice1M`）

**Step 2：UserModelUsage 输入用量/费用字段重命名与新增**
- `InputTokens` 重命名为 `InputFreshTokens`
- `InputCost` 重命名为 `InputFreshCost`
- `CacheTokens` 重命名为 `InputCachedTokens`（或新增）
- `CacheCost` 重命名为 `InputCachedCost`（或新增）

**Step 3：StepContentThink.Signature 类型变更**
- 将 `Signature` 从 `varbinary` 转换为 `nvarchar(max)`
- 数据迁移：将二进制数据转换为 Base64 编码字符串

---

## 📊 代码统计

### 整体变更

- **提交数量**：77 次提交
- **主要变更**：小米 MiMo 支持、缓存计费、框架升级、交错思考、4 级视图架构

### 关键模块

**后端新增/重写**：
- `MimoChatService.cs` - 59 行（小米 OpenAI 格式）
- `MimoAnthropicService.cs` - 40 行（小米 Anthropic 格式）
- `MiniMaxChatService.cs` - 126 行（Minimax 交错思考）
- `DeepSeekChatService.cs` - 46 行（DeepSeek 交错思考）
- `GoogleAI2ChatService.cs` - 重写 +607 行（原生 HttpClient）

**前端新增**：
- `rehypeKatexWithCopy.ts` - 116 行（LaTeX 复制插件）
- `useMathCopy.ts` - 135 行（数学公式复制 hook）
- `StepDivider.tsx` - 141 行（步骤分隔组件）

**测试新增**：
- `MiniMaxChatServiceTests.cs` - 113 行
- `DeepSeekChatServiceTests.cs` - 63 行
- Google Gemini 单元测试

---

## 🚀 升级指南

### 从 1.9.0 升级到 1.9.1

1. **备份数据库**（强烈建议）
2. **停止应用服务**
3. **执行数据库迁移**：
   ```bash
   sqlcmd -S localhost -d Chats -i 1.9.1.sql
   ```
4. **更新后端代码**
5. **更新前端代码**（注意 React 19 变更）
6. **启动应用服务**
7. **验证功能**：
   - 测试小米 MiMo 模型是否正常工作
   - 测试 Prompt Cache Token 显示
   - 测试交错思考功能
   - 测试 LaTeX 公式复制
   - 验证现有聊天记录显示正常

### 新功能使用说明

**添加小米 MiMo 模型**：
1. 进入模型管理页面
2. 选择小米（Xiaomi）提供商
3. 填写 API Key
4. 添加模型
5. 可选启用 Thinking 功能

**配置 Prompt Cache 价格**：
1. 进入模型管理页面
2. 编辑支持缓存的模型（如 Claude 系列）
3. 在价格配置中填写缓存输入价格
4. 保存后生成信息将显示缓存 token 使用量

---

## ⚠️ 破坏性变更

### 1. 前端框架版本

- React 从 18.2.0 升级到 19.2.1
- Next.js 从 15.5.3 升级到 16.0.7
- 如有自定义前端组件需要适配新版本

### 2. SDK 依赖移除

- 移除 `Azure.AI.OpenAI` / OpenAI .NET SDK
- 移除 `Mscc.GenerativeAI`
- 如有依赖这些库的自定义代码需要调整

### 3. 数据库字段重命名

- `Model.InputTokenPrice1M` → `Model.InputFreshTokenPrice1M`
- `UserModelUsage.InputTokens` → `UserModelUsage.InputFreshTokens`
- `UserModelUsage.InputCost` → `UserModelUsage.InputFreshCost`

---

## 🎓 学习资源

### 相关文档

- 📖 [1.9.0 发布说明](./1.9.0.md) - 了解上一个版本的更新
- 📖 [React 19 升级指南](https://react.dev/blog/2024/12/05/react-19) - 官方 React 19 文档
- 📖 [Next.js 16 文档](https://nextjs.org/docs) - 官方 Next.js 文档

### 社区支持

- 🐛 [报告问题](https://github.com/sdcb/chats/issues)
- 💬 [参与讨论](https://github.com/sdcb/chats/discussions)
- 📧 联系作者：[https://github.com/sdcb](https://github.com/sdcb)

---

## 📝 更新日志摘要

### 新增功能

- ✅ 小米 MiMo 模型提供商支持（ID=21）
- ✅ Minimax/DeepSeek Anthropic API 格式支持
- ✅ Prompt Cache Token 计费功能
- ✅ 交错思考（Interleaved Thinking）支持
- ✅ chat/turn/step/content 4 级聊天视图架构
- ✅ LaTeX 公式一键复制
- ✅ TokenPony 支持 deepseek-v3.* thinking
- ✅ 登录页版本号显示

### 框架升级

- ✅ Next.js 15.5.3 → 16.0.7
- ✅ React 18.2.0 → 19.2.1
- ✅ 升级所有 @radix-ui 包
- ✅ 移除 OpenAI .NET SDK
- ✅ 移除 Mscc.GenerativeAI

### 问题修复

- ✅ 修复 DeepSeek-R1 thinking signature 解析问题
- ✅ 修复 prompt token 统计问题
- ✅ 修复图片生成矩形问题
- ✅ 修复 gpt-image-1.5 支持
- ✅ 修复 ChatModelDropdownMenu 闪烁
- ✅ 修复 MCP 标签不显示
- ✅ 修复页面刷新滚动问题

### 数据库迁移

- ✅ Model 表价格字段重命名（支持缓存价格）
- ✅ UserModelUsage 表字段重命名（支持缓存统计）
- ✅ StepContentThink.Signature 类型从 varbinary 改为 nvarchar(max)

### 其他改进

- ✅ 添加 Gemini/DeepSeek/Minimax 单元测试
- ✅ 统一异常处理
- ✅ 添加 HttpClient UserAgent
- ✅ 优化 CI 缓存
- ✅ 添加模型提供商引入日期

---

<p align="center">
  <sub>最后更新：2025-12-21</sub>
</p>
