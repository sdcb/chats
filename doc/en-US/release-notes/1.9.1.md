<!-- Language: en-US -->
<p><a href="./README.md">üìã All Versions</a> <span style="float:right"><b>English</b> | <a href="../../zh-CN/release-notes/1.9.1.md">ÁÆÄ‰Ωì‰∏≠Êñá</a></span></p>

# Chats 1.9.1 Release Notes

> Release Date: 2025-12-21 (77 commits since 1.9.0)

1.9.1 is a significant feature enhancement and stability update, with core highlights including **Xiaomi MiMo model provider support**, **Prompt Cache Token billing**, **Next.js 16 and React 19 upgrades**, **Interleaved Thinking support**, and a **brand new 4-level chat view architecture**. This version also removes dependencies on OpenAI .NET SDK and Mscc.GenerativeAI, replacing them with native HttpClient for better controllability.

## üéØ Core Features

### 1) Xiaomi MiMo Model Provider

**Added Xiaomi MiMo Provider** (ID=21):
- Supports Xiaomi MiMo-V2-Flash large model
- Simultaneously supports OpenAI Chat Completions API and Anthropic Messages API format calls
- Supports Chain of Thought (Thinking) functionality
- Added `xiaomi.png` icon (self-hosted)
- Introduced `MimoInterleavedToolCallTransformer` for Mimo, supporting interleaved thinking tool calls in tools like `Claude Code`

**Backend Implementation**:
- `MimoChatService.cs` - OpenAI format call implementation
- `MimoAnthropicService.cs` - Anthropic format call implementation
- Fixed issue where tool property was null during non-streaming API calls

### 2) Prompt Cache Token Support

**Cache Billing Functionality**:
- Added Prompt Cache Token price configuration (for models supporting caching like Anthropic)
- Model prices distinguish between Fresh Token and Cached Token
- Displays cache token usage in generation information
- Anthropic API returns `CacheCreationTokens` and `CacheReadTokens`

**Database Changes**:
- `Model.InputTokenPrice1M` renamed to `InputFreshTokenPrice1M`
- Added `Model.InputCachedTokenPrice1M` column
- `UserModelUsage` table supports separate statistics for Fresh/Cached Token usage and costs

### 3) Interleaved Thinking Support

**Supported Model Providers**:
- Minimax - Supports Chat Completions API format interleaved thinking
- DeepSeek - Supports Chat Completions API format interleaved thinking
- Fixed DeepSeek-R1 thinking signature non-base64 format issue

**Technical Implementation**:
- `MiniMaxChatService.cs` - Minimax dedicated chat service (126 lines)
- `DeepSeekChatService.cs` - DeepSeek dedicated chat service (46 lines)
- Enhanced interleaved thinking message parsing in `ChatCompletionService.cs`

### 4) 4-Level Chat View Architecture

**Architecture Refactoring**:
- Introduced chat/turn/step/content four-level structure
- More clearly displays conversation flow and generation information
- Uses generation information bubbles instead of StepDivider
- More accurate thinking message duration from step

**Frontend Improvements**:
- Refactored `ChatView.tsx` to support new architecture
- Updated `ResponseMessage.tsx` to support multi-level content display
- Optimized generation information caching logic

### 5) LaTeX Formula Copy Functionality

**New Features**:
- LaTeX formulas support one-click copying of original formula code
- Introduced `rehypeKatexWithCopy.ts` custom rehype plugin
- Added `useMathCopy.ts` hook to handle copy interactions

---

## üèóÔ∏è Architecture Improvements

### 1) Frontend Framework Upgrade

**Next.js Upgrade** (15.5.3 ‚Üí 16.0.7):
- Migrated to new ESLint configuration format (`eslint.config.js`)
- Updated pages and components to adapt to new API
- Fixed numerous compatibility issues caused by upgrade

**React Upgrade** (18.2.0 ‚Üí 19.2.1):
- Adapted to React 19 new features
- Fixed `ChatModelDropdownMenu` flickering issue
- Fixed `ChatPresetModal` console errors
- Fixed MCP tab not displaying in model settings dialog

**Dependency Updates**:
- Upgraded all `@radix-ui` packages to latest versions
- Executed `npm audit fix`, upgraded Next.js security patches

### 2) Backend SDK Cleanup

**Removed OpenAI .NET SDK**:
- Deleted `Azure.AI.OpenAI` dependency
- Replaced with native `HttpClient` implementation for Chat Completions API
- Fixed token statistics and tool call issues caused by migration

**Removed Mscc.GenerativeAI**:
- Deleted `Mscc.GenerativeAI` dependency
- Rewrote `GoogleAI2ChatService.cs` (+607 lines) using native HttpClient
- Better support for Gemini 3 series models
- Fixed edge cases in Gemini image generation API

### 3) Unified Exception Handling

- Unified ChatService exceptions to `RawChatServiceException` and `ChatServiceException`
- Optimized error message display, showing complete JSON instead of just messages
- Optimized Response API error handling for non-async models

### 4) Signature Storage Format Change

- `StepContentThink.Signature` changed from binary `varbinary` to string format
- Now stored in text format (whether base64/guid or other forms) as-is for easier handling of non-standard formats like DeepSeek-R1

---

## üêõ Bug Fixes

### 1) Model Service Fixes

- Fixed DeepSeek-R1 thinking signature non-base64 format parsing issue
- Fixed prompt token not being correctly counted when user stops chat midway
- Fixed Response API tool call issues
- Fixed signature handling issues when Gemini has no tool calls (better support for Gemini 3)
- Fixed TokenPony support for deepseek-v3.* model thinking functionality
- Specified `parallel_tool_calls` in chat completions api web chat scenarios

### 2) Image Generation Fixes

- Fixed issue where generated images were always rectangular
- Fixed gpt-image-1.5 model support
- Fixed Gemini image generation API failing in certain edge cases

### 3) Frontend Fixes

- Fixed `ChatModelDropdownMenu` component flickering issue (caused by React/Next.js upgrade)
- Fixed MCP tab not displaying in chat header model settings dialog
- Fixed `ChatPresetModal` showing React errors in F12 console
- Fixed not displaying correct last message when refreshing page
- Fixed auto-scrolling to last message on page refresh
- Fixed frontend build warnings caused by `_error.tsx`

### 4) API Fixes

- Fixed HTTP 500 error for `{turnId}/{contentId}/text-and-save-new` endpoint
- Fixed Google AI list models functionality
- Fixed API Key format display issue on usage page
- Forced usage page to get single data source from URL

---

## üíÑ UI/UX Optimizations

### 1) Login Page Improvements

- Added version number display
- Optimized subtitle font size for small screens (mobile)
- Removed unregistered TM symbol, kept ¬© copyright symbol

### 2) Error Display Optimization

- Used monospace font for error messages
- Optimized error colors in dark theme
- Displayed complete error JSON instead of just messages

### 3) Chat Interface Optimization

- Used generation information bubbles instead of StepDivider to display step usage information
- More accurate thinking message duration from step
- Simplified ChatSegment component
- Deleted unused `alert.tsx` component

---

## üîß Other Improvements

### 1) Testing & Quality

- Added Google Gemini unit tests
- Added DeepSeek Chat Service tests
- Added Minimax Chat Service tests
- Fixed FiddlerHttpDump tests
- Added dump request assertions

### 2) Security & Standards

- Added UserAgent to all HttpClient requests
- Fixed Mimo model API Key header issue not requiring Authorization Bearer

### 3) Build & Deployment

- Optimized CI cache trigger strategy
- Moved version number from window global variable to environment variables
- Added introduce date field for all model providers

### 4) Documentation

- Moved Release Notes to top of README.md
- Added icons for Release Notes

---

## üóÑÔ∏è Database Migration

**Migration Script Location**:
```
src/scripts/db-migration/1.9/1.9.1.sql
```

### Migration Content

**Step 1: Model table price field rename and add cache price**
- `InputTokenPrice1M` renamed to `InputFreshTokenPrice1M`
- Added `InputCachedTokenPrice1M` column (initial value equals `InputFreshTokenPrice1M`)

**Step 2: UserModelUsage input usage/cost field rename and add**
- `InputTokens` renamed to `InputFreshTokens`
- `InputCost` renamed to `InputFreshCost`
- `CacheTokens` renamed to `InputCachedTokens` (or added)
- `CacheCost` renamed to `InputCachedCost` (or added)

**Step 3: StepContentThink.Signature type change**
- Changed `Signature` from `varbinary` to `nvarchar(max)`
- Data migration: Convert binary data to Base64 encoded string

---

## üìä Code Statistics

### Overall Changes

- **Commit Count**: 77 commits
- **Main Changes**: Xiaomi MiMo support, cache billing, framework upgrades, interleaved thinking, 4-level view architecture

### Key Modules

**Backend New/Rewritten**:
- `MimoChatService.cs` - 59 lines (Xiaomi OpenAI format)
- `MimoAnthropicService.cs` - 40 lines (Xiaomi Anthropic format)
- `MiniMaxChatService.cs` - 126 lines (Minimax interleaved thinking)
- `DeepSeekChatService.cs` - 46 lines (DeepSeek interleaved thinking)
- `GoogleAI2ChatService.cs` - Rewritten +607 lines (native HttpClient)

**Frontend New**:
- `rehypeKatexWithCopy.ts` - 116 lines (LaTeX copy plugin)
- `useMathCopy.ts` - 135 lines (math formula copy hook)
- `StepDivider.tsx` - 141 lines (step divider component)

**Testing New**:
- `MiniMaxChatServiceTests.cs` - 113 lines
- `DeepSeekChatServiceTests.cs` - 63 lines
- Google Gemini unit tests

---

## üöÄ Upgrade Guide

### Upgrading from 1.9.0 to 1.9.1

1. **Backup Database** (Strongly Recommended)
2. **Stop Application Service**
3. **Execute Database Migration**:
   ```bash
   sqlcmd -S localhost -d Chats -i 1.9.1.sql
   ```
4. **Update Backend Code**
5. **Update Frontend Code** (Note React 19 Changes)
6. **Start Application Service**
7. **Verify Functionality**:
   - Test Xiaomi MiMo model works correctly
   - Test Prompt Cache Token display
   - Test interleaved thinking functionality
   - Test LaTeX formula copy
   - Verify existing chat history displays correctly

### New Feature Usage Instructions

**Add Xiaomi MiMo Model**:
1. Go to Model Management Page
2. Select Xiaomi Provider
3. Fill in API Key
4. Add Model
5. Optionally enable Thinking functionality

**Configure Prompt Cache Prices**:
1. Go to Model Management Page
2. Edit models supporting cache (e.g., Claude series)
3. Fill in cache input price in price configuration
4. Save and generation information will display cache token usage

---

## ‚ö†Ô∏è Breaking Changes

### 1. Frontend Framework Versions

- React upgraded from 18.2.0 to 19.2.1
- Next.js upgraded from 15.5.3 to 16.0.7
- Custom frontend components need adaptation to new versions

### 2. SDK Dependency Removals

- Removed `Azure.AI.OpenAI` / OpenAI .NET SDK
- Removed `Mscc.GenerativeAI`
- Custom code depending on these libraries needs adjustment

### 3. Database Field Renames

- `Model.InputTokenPrice1M` ‚Üí `Model.InputFreshTokenPrice1M`
- `UserModelUsage.InputTokens` ‚Üí `UserModelUsage.InputFreshTokens`
- `UserModelUsage.InputCost` ‚Üí `UserModelUsage.InputFreshCost`

---

## üéì Learning Resources

### Related Documentation

- üìñ [1.9.0 Release Notes](./1.9.0.md) - Understand previous version updates
- üìñ [React 19 Upgrade Guide](https://react.dev/blog/2024/12/05/react-19) - Official React 19 documentation
- üìñ [Next.js 16 Documentation](https://nextjs.org/docs) - Official Next.js documentation

### Community Support

- üêõ [Report Issues](https://github.com/sdcb/chats/issues)
- üí¨ [Join Discussions](https://github.com/sdcb/chats/discussions)
- üìß Contact Author: [https://github.com/sdcb](https://github.com/sdcb)

---

## üìù Changelog Summary

### New Features

- ‚úÖ Xiaomi MiMo model provider support (ID=21)
- ‚úÖ Minimax/DeepSeek Anthropic API format support
- ‚úÖ Prompt Cache Token billing functionality
- ‚úÖ Interleaved Thinking support
- ‚úÖ chat/turn/step/content 4-level chat view architecture
- ‚úÖ LaTeX formula one-click copy
- ‚úÖ TokenPony support for deepseek-v3.* thinking
- ‚úÖ Login page version number display

### Framework Upgrades

- ‚úÖ Next.js 15.5.3 ‚Üí 16.0.7
- ‚úÖ React 18.2.0 ‚Üí 19.2.1
- ‚úÖ Upgraded all @radix-ui packages
- ‚úÖ Removed OpenAI .NET SDK
- ‚úÖ Removed Mscc.GenerativeAI

### Bug Fixes

- ‚úÖ Fixed DeepSeek-R1 thinking signature parsing issue
- ‚úÖ Fixed prompt token counting issue
- ‚úÖ Fixed image generation rectangular issue
- ‚úÖ Fixed gpt-image-1.5 support
- ‚úÖ Fixed ChatModelDropdownMenu flickering
- ‚úÖ Fixed MCP tab not displaying
- ‚úÖ Fixed page refresh scrolling issue

### Database Migration

- ‚úÖ Model table price field rename (support cache price)
- ‚úÖ UserModelUsage table field rename (support cache statistics)
- ‚úÖ StepContentThink.Signature type from varbinary to nvarchar(max)

### Other Improvements

- ‚úÖ Added Gemini/DeepSeek/Minimax unit tests
- ‚úÖ Unified exception handling
- ‚úÖ Added HttpClient UserAgent
- ‚úÖ Optimized CI cache
- ‚úÖ Added model provider introduce date

---

<p align="center">
  <sub>Last updated: 2025-12-21</sub>
</p>