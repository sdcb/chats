<!-- Language: en-US -->
<p><a href="./README.md">üìã All Releases</a> <span style="float:right"><b>English</b> | <a href="../../zh-CN/release-notes/1.9.0.md">ÁÆÄ‰Ωì‰∏≠Êñá</a></span></p>

# Chats 1.9.0 Release Notes

> Release Date: 2025-11-27 (80 commits since 1.8.1.279)

1.9.0 is a major version update. Core highlights include **Anthropic Model Provider Support**, **Anthropic Messages API Compatible Interface**, **OpenAI Image Generation/Edit API**, **Build Developer Pages**, and **Comprehensive UI Animation Improvements**. This release also upgrades to .NET 10 and refactors the ChatService architecture to support Claude model's thinking+signature flow.

## üéØ Core Features

### 1) Anthropic Model Provider Support

**New Anthropic Provider** (ID=20):
- Full support for Claude model series (including claude-opus-4-5 and other latest models)
- Implemented with native HttpClient, removed Anthropic .NET SDK to resolve compatibility issues
- Support for Claude's unique thinking + signature flow
- Default URL: `https://api.anthropic.com`
- New `anthropic.svg` icon

**Anthropic Model Features**:
- Support for `MaxThinkingBudget` (model level) and `ThinkingBudget` (session level) configuration
- Vision Link enabled by default (pass images via URL instead of base64)
- Support for built-in `web_search` and MCP tool calls
- Support for Claude model's `signature` field storage

**Database Schema Changes**:
- New `StepContentThink` table with `Content` and `Signature` fields
- Migrate existing reasoning data from `StepContentText` to `StepContentThink`
- New `Model.MaxThinkingBudget` column
- New `ChatConfig.ThinkingBudget` column

**Backend Refactor**:
- `AnthropicChatService` reimplemented with native HttpClient (969 lines)
- Support for `JsonPolymorphic` attribute to handle Anthropic streaming events
- ChatService architecture changed to DB Steps driven, supporting multiple message format conversions

### 2) External API Enhancements

**Anthropic Messages API** (/v1/messages):
- Fully compatible with Anthropic Messages API specification
- Support for streaming and non-streaming responses
- Support for Tool Use (function calling)
- Support for System Prompt parsing
- Token count API implementation (/v1/messages/count_tokens)

**Core Components** (6 new files):
- `AnthropicCompatibleController.cs` (380 lines) - API endpoint controller
- `AnthropicRequest.cs` (140 lines) - Request DTO
- `AnthropicResponse.cs` (105 lines) - Response DTO
- `AnthropicStreamEvent.cs` (227 lines) - Streaming event definitions
- `AnthropicRequestWrapper.cs` (307 lines) - Request transformer
- `AnthropicSegmentExtensions.cs` (112 lines) - Message segment extensions

**OpenAI Image API**:
- Image generation API (POST /v1/images/generations)
- Image edit API (POST /v1/images/edits)
- `OpenAIImageController.cs` (478 lines) - Complete image API implementation
- `ImageGenerationDtos.cs` (171 lines) - Image API DTO definitions

**API Type Enforcement**:
- OpenAI compatible endpoints enforce `ChatCompletion` type models
- Anthropic compatible endpoints enforce `Anthropic` type models
- Clear error returned when interface and model type mismatch

### 3) Build Developer Pages

**New Build Layout and Pages** (for API developers):
- `BuildLayout.tsx` (201 lines) - Unified Build page layout
- Three core pages: API Keys, Docs, Usage

**API Keys Page** (/build/api-key):
- Create, edit, delete API key management
- Key masking display (prevent sensitive info leakage in screenshots)
- Support for setting key comments and expiration time
- Display last used time
- Click key to view usage records for that key
- Responsive layout (mobile-friendly)

**Docs Page** (/build/docs):
- Categorized display of OpenAI compatible and Anthropic compatible APIs
- Display full API URL (one-click copy)
- Links to official documentation
- OpenAI Compatible APIs:
  - Chat Completions (/v1/chat/completions)
  - List Models (/v1/models)
  - Image Generations (/v1/images/generations)
  - Image Edit (/v1/images/edits)
- Anthropic Compatible APIs:
  - Messages (/v1/messages)
  - Count Tokens (/v1/messages/count_tokens)

**Usage Page** (/build/usage):
- Reuses existing `UsageRecordsTab` component
- Support filtering usage records by API Key

### 4) UI Optimizations and Animations

**ChatInput Animation Optimization**:
- Smooth transition animation when expanding/collapsing
- Full-screen toggle animation effect
- Fixed height not resetting after sending message
- Fixed flashing issue during chat

**UserMenuPopover Component Unification**:
- Extracted as independent component, reused in chat and admin pages
- Added dropdown menu animation effects
- New Tailwind animation configuration

**ToolCallBlock Optimization**:
- Added animation transition for header expand/collapse
- Fixed auto-expand behavior issue
- Optimized visual appearance in light theme
- Optimized frontend rendering of Anthropic's built-in `web_search` tool

**Other UI Improvements**:
- Fixed sub-pixel line issue under UserMessage
- Optimized mobile layout for admin pages
- Optimized model management page labels and description UI
- Added loading indicator for chat deletion confirmation
- Chat cache synced with create/delete operations

---

## üèóÔ∏è Architecture Improvements

### 1) Upgrade to .NET 10

- Framework upgraded from .NET 9 to .NET 10
- Updated all related NuGet packages
- OpenAI SDK upgraded to 2.7.0
- Build process switched to Ubuntu 24.04

### 2) ChatService Architecture Refactor

**Core Changes**:
- ChatService changed from OpenAI payload driven to DB Steps driven
- New `ChatServiceRequest` class to encapsulate request data
- Support for Anthropic's thinking+signature flow
- ChatService changed to DI singleton registration
- ChatService no longer inherits `IDisposable`

**Code Optimization**:
- Deleted `ChatServiceExtensions.cs` (136 lines)
- Deleted `TestChatService.cs` (76 lines)
- Simplified various ChatService implementations
- Unified request/response processing flow

### 3) New Model.SupportsVisionLink Field

- Controls image transmission method: URL link or Base64 encoding
- Enabled by default for Anthropic models (uses URL)
- Disabled by default for other models (uses Base64 for better compatibility)
- Can be manually toggled in model configuration

---

## üêõ Bug Fixes

### 1) Thinking Budget Fix
- Fixed issue where thinking budget settings couldn't be applied
- Correctly pass model-level and session-level budget configuration

### 2) Gemini Related Fixes
- Fixed issue where conversation failed after enabling thinking
- Disabled Google Gemini auto-retry to work around upstream bug (mscraftsman/generative-ai#144)

### 3) UI Related Fixes
- Fixed ChatInput height not resetting after sending message
- Fixed sub-pixel line display issue under UserMessage
- Fixed ToolCallBlock auto-expand behavior anomaly
- Fixed FilePreview missing in non-fullscreen mode
- Fixed Quick Add Model failure due to VisionLink changes
- Fixed admin model page "show all providers" button not working

### 4) API Related Fixes
- Fixed Anthropic Messages API tool call finish reason handling
- Fixed Anthropic Messages API system prompt parsing (supports Claude Code)
- Fixed ApiType switch affecting model price

---

## üóÑÔ∏è Database Migration

**Migration Script Location**:
```
src/scripts/db-migration/1.9/1.9.0.sql
```

### Migration Content

**Step 1: Create StepContentThink Table**
```sql
CREATE TABLE dbo.StepContentThink (
    Id BIGINT NOT NULL,
    Content NVARCHAR(MAX) NOT NULL,
    Signature VARBINARY(MAX) NULL,
    CONSTRAINT PK_StepContentThink PRIMARY KEY CLUSTERED (Id),
    CONSTRAINT FK_StepContentThink_StepContent FOREIGN KEY (Id) REFERENCES dbo.StepContent (Id)
);
```

**Step 2: Migrate reasoning data**
- Move records with `ContentTypeId = 3` from `StepContentText` to `StepContentThink`

**Step 3: Remove StepContentType Table**
- Drop foreign key constraints and table itself

**Step 4: File.MediaType Transformation**
- Add `File.MediaType` column
- Migrate `FileContentType` data
- Drop `FileContentType` table

**Step 5: StepContentBlob Enhancement**
- Add `MediaType` and `FileName` columns

**Step 6: Remove ChatRole Table**
- Drop `Step` table foreign key constraint
- Drop `ChatRole` table

**Step 7: Model/ChatConfig Table Adjustments**
- Drop `Model.AllowSystemPrompt` column
- Add `Model.MaxThinkingBudget` column
- Add `ChatConfig.ThinkingBudget` column
- Change `ReasoningEffortOptions` and `SupportedImageSizes` to nullable

**Step 8: Field Renaming**
- `ChatConfig.ReasoningEffort` ‚Üí `ChatConfig.ReasoningEffortId`
- `Model.ApiType` ‚Üí `Model.ApiTypeId`

**Step 9: Add Model.SupportsVisionLink**
- Add boolean field, default false

### Migration Steps

1. **Backup database** (strongly recommended)
2. **Stop application services**
3. **Execute migration script**:
   ```bash
   sqlcmd -S localhost -d Chats -i 1.9.0.sql
   ```
4. **Verify migration results**
5. **Update application**
6. **Start services**

---

## üìä Code Statistics

### Overall Changes

- **Commit Count**: 80 commits
- **Major Changes**: Anthropic support, API enhancements, Build pages, animation optimization, .NET 10 upgrade

### Key Modules

**Backend New**:
- `AnthropicChatService.cs` - 969 lines (Anthropic chat service)
- `AnthropicCompatibleController.cs` - 380 lines (Anthropic API controller)
- `AnthropicRequestWrapper.cs` - 307 lines (request transformation)
- `AnthropicStreamEvent.cs` - 227 lines (streaming events)
- `OpenAIImageController.cs` - 478 lines (image API)
- `ChatServiceRequest.cs` - 115 lines (request encapsulation)

**Frontend New**:
- `BuildLayout.tsx` - 201 lines (Build layout)
- `BuildApiKeyPage` - 255 lines (API Key management)
- `BuildDocsPage` - 120 lines (API documentation)
- `UserMenuPopover.tsx` - 110 lines (user menu component)

**Database Migration**:
- `1.9.0.sql` - 421 lines (complete migration script)

---

## üöÄ Upgrade Guide

### Upgrading from 1.8.1 to 1.9.0

1. **Backup database** (strongly recommended, this version has major architecture changes)
2. **Stop application services**
3. **Execute database migration**:
   ```bash
   sqlcmd -S localhost -d Chats -i 1.9.0.sql
   ```
4. **Update .NET runtime to 10.0**
5. **Update backend code**
6. **Update frontend code**
7. **Start application services**
8. **Verify functionality**:
   - Test Anthropic models work correctly
   - Test Build page features
   - Test Anthropic Messages API
   - Test image generation API
   - Verify existing chat history thinking content displays correctly

### New Feature Usage Guide

**Adding Anthropic Models**:
1. Go to model management page
2. Select Anthropic provider
3. Enter API Key (obtained from Anthropic Console)
4. Add model (e.g., claude-sonnet-4-5-20250514)
5. Optionally configure MaxThinkingBudget

**Using Build Pages**:
1. Click "Build" option in user menu
2. Create new API Key on API Keys page
3. View supported API endpoints on Docs page
4. View usage records on Usage page

**Calling Anthropic Messages API**:
```bash
curl -X POST https://your-chats-url/v1/messages \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -H "anthropic-version: 2023-06-01" \
  -d '{
    "model": "claude-sonnet-4-5-20250514",
    "max_tokens": 1024,
    "messages": [{"role": "user", "content": "Hello!"}]
  }'
```

---

## ‚ö†Ô∏è Breaking Changes

### 1. .NET Version Upgrade

- Runtime requirement upgraded from .NET 9 to .NET 10
- Deployment environment needs .NET 10 runtime installed

### 2. Database Schema Changes

**Deleted Tables**:
- `StepContentType`
- `FileContentType`
- `ChatRole`

**Renamed Fields**:
- `Model.ApiType` ‚Üí `Model.ApiTypeId`
- `ChatConfig.ReasoningEffort` ‚Üí `ChatConfig.ReasoningEffortId`

**Deleted Fields**:
- `Model.AllowSystemPrompt`

### 3. ChatService Interface Changes

- ChatService no longer inherits `IDisposable`
- Constructor signatures may have changed
- Custom ChatService implementations need to adapt to new architecture

---

## üìù Known Limitations

- Anthropic service does not currently support prompt caching, which may affect cost optimization for long conversations

---

## üéì Learning Resources

### Related Documentation

- üìñ [1.8.1 Release Notes](./1.8.1.md) - Learn about previous version updates
- üìñ [Anthropic API Documentation](https://docs.anthropic.com/en/api/messages) - Official Messages API reference
- üìñ [OpenAI Images API Documentation](https://platform.openai.com/docs/api-reference/images) - Official image API reference

### Community Support

- üêõ [Report Issues](https://github.com/sdcb/chats/issues)
- üí¨ [Join Discussions](https://github.com/sdcb/chats/discussions)
- üìß Contact Author: [https://github.com/sdcb](https://github.com/sdcb)

---

## üôè Contributors

Thanks to all developers who contributed to this release!

Special thanks to:
- [@sdcb](https://github.com/sdcb) - Anthropic provider support, Messages API, Image API, Build pages, UI animations, .NET 10 upgrade, database architecture refactor

If you have any questions or suggestions, please provide feedback on [GitHub Issues](https://github.com/sdcb/chats/issues).

---

## üìù Changelog Summary

### New Features

- ‚úÖ Anthropic model provider support (ID=20)
- ‚úÖ Anthropic Messages API compatible interface (/v1/messages)
- ‚úÖ Anthropic Token count API (/v1/messages/count_tokens)
- ‚úÖ OpenAI image generation API (/v1/images/generations)
- ‚úÖ OpenAI image edit API (/v1/images/edits)
- ‚úÖ Build developer pages (API Keys / Docs / Usage)
- ‚úÖ API key masking display
- ‚úÖ ChatInput expand/collapse/fullscreen animation
- ‚úÖ UserMenuPopover animation effects
- ‚úÖ ToolCallBlock header animation
- ‚úÖ Model.SupportsVisionLink field

### Architecture Improvements

- ‚úÖ Upgraded to .NET 10
- ‚úÖ ChatService architecture refactor (DB Steps driven)
- ‚úÖ New StepContentThink table supporting Claude signature
- ‚úÖ ChatService changed to DI singleton registration
- ‚úÖ Unified UserMenuPopover component

### Bug Fixes

- ‚úÖ Fixed thinking budget not applying issue
- ‚úÖ Fixed Gemini unable to chat after enabling thinking
- ‚úÖ Fixed ChatInput height reset issue
- ‚úÖ Fixed UserMessage sub-pixel line issue
- ‚úÖ Fixed ToolCallBlock auto-expand anomaly
- ‚úÖ Fixed FilePreview missing in non-fullscreen mode
- ‚úÖ Fixed Anthropic API tool call finish reason
- ‚úÖ Disabled Google Gemini retry to work around upstream bug

### Database Migration

- ‚úÖ Create StepContentThink table (with Signature field)
- ‚úÖ Migrate reasoning data
- ‚úÖ Remove StepContentType/FileContentType/ChatRole tables
- ‚úÖ Add Model.MaxThinkingBudget field
- ‚úÖ Add ChatConfig.ThinkingBudget field
- ‚úÖ Add Model.SupportsVisionLink field
- ‚úÖ Field renaming (ApiType‚ÜíApiTypeId, ReasoningEffort‚ÜíReasoningEffortId)

### Code Cleanup

- ‚úÖ Deleted ChatServiceExtensions.cs
- ‚úÖ Deleted TestChatService.cs
- ‚úÖ Removed Anthropic .NET SDK dependency
- ‚úÖ Simplified ChatService implementations

---

<p align="center">
  <sub>Last updated: 2025-11-27</sub>
</p>
